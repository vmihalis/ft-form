---
phase: 27-form-generation-preview
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ai-wizard/schema-extraction.ts
autonomous: true

must_haves:
  truths:
    - "Schema extraction detects JSON code blocks in AI responses"
    - "Valid schemas pass both structural and semantic validation"
    - "Invalid JSON returns parse error, not crash"
    - "Missing schema returns found: false without error"
  artifacts:
    - path: "src/components/ai-wizard/schema-extraction.ts"
      provides: "Schema extraction utility for AI responses"
      exports: ["extractFormSchema", "mightContainSchema", "SchemaExtractionResult"]
  key_links:
    - from: "src/components/ai-wizard/schema-extraction.ts"
      to: "src/lib/ai/validate-schema.ts"
      via: "import validateAIFormSchema"
      pattern: "validateAIFormSchema"
---

<objective>
Create schema extraction utility that detects and validates form schemas from AI responses

Purpose: Bridge between AI chat output (text with markdown JSON blocks) and validated FormSchema objects for preview
Output: `schema-extraction.ts` with functions to extract, parse, and validate AI-generated form schemas
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-form-generation-preview/27-RESEARCH.md

# Key files for this plan
@src/lib/ai/validate-schema.ts
@src/lib/ai/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema extraction utility</name>
  <files>src/components/ai-wizard/schema-extraction.ts</files>
  <action>
Create schema extraction utility at `src/components/ai-wizard/schema-extraction.ts`:

1. Define `SchemaExtractionResult` interface:
   ```typescript
   export interface SchemaExtractionResult {
     found: boolean;        // Whether a JSON code block was detected
     valid: boolean;        // Whether it passed validation (only meaningful if found)
     schema: AIFormSchemaOutput | null;  // Validated schema if valid
     errors: string[] | null;            // Validation or parse errors if found but invalid
   }
   ```

2. Implement `mightContainSchema(content: string): boolean`:
   - Quick pre-check to avoid expensive parsing
   - Returns true if content contains BOTH:
     - `\`\`\`json` marker
     - `"steps"` string (key schema indicator)
   - This is for early filtering, not validation

3. Implement `extractFormSchema(content: string): SchemaExtractionResult`:
   - Pattern match for JSON code blocks using these patterns (try in order):
     - `/\`\`\`json\s*\n([\s\S]*?)\n\s*\`\`\`/` (standard markdown JSON block)
     - `/\`\`\`\s*\n(\{[\s\S]*?\})\n\s*\`\`\`/` (code block without language, starts with {)
   - If no match found: return `{ found: false, valid: false, schema: null, errors: null }`
   - If match found:
     - Try `JSON.parse()` on extracted content
     - On parse error: return `{ found: true, valid: false, schema: null, errors: ['Invalid JSON: {message}'] }`
     - On parse success: call `validateAIFormSchema(parsed)`
     - If validation succeeds: return `{ found: true, valid: true, schema: validation.data, errors: null }`
     - If validation fails: return `{ found: true, valid: false, schema: null, errors: validation.errors }`

Import `validateAIFormSchema` from `@/lib/ai/validate-schema` and `AIFormSchemaOutput` type from `@/lib/ai/schemas`.

Do NOT try to extract multiple schemas - take the first match only (AI should output one schema per generation).
  </action>
  <verify>
Create a simple test in the terminal using Node:
```bash
cd /Users/memehalis/ft-form && npx tsx -e "
import { extractFormSchema, mightContainSchema } from './src/components/ai-wizard/schema-extraction';

// Test 1: No schema
console.log('Test 1 - No schema:', extractFormSchema('Hello world'));

// Test 2: Quick check
console.log('Test 2 - mightContainSchema:', mightContainSchema('\`\`\`json\\n{\"steps\": []}\\n\`\`\`'));

// Test 3: Valid schema (minimal)
const validContent = '\`\`\`json\\n{\"steps\": [{\"id\": \"step_1\", \"title\": \"Contact\", \"fields\": [{\"id\": \"name\", \"type\": \"text\", \"label\": \"Name\", \"required\": true}]}], \"settings\": {\"submitButtonText\": \"Submit\", \"successMessage\": \"Thanks!\"}}\\n\`\`\`';
const result = extractFormSchema(validContent);
console.log('Test 3 - Valid schema:', result.found, result.valid, result.errors);

// Test 4: Invalid JSON
const invalidJson = '\`\`\`json\\n{invalid json}\\n\`\`\`';
console.log('Test 4 - Invalid JSON:', extractFormSchema(invalidJson));
"
```
All tests should pass without errors.
  </verify>
  <done>
- `mightContainSchema()` returns true only when content has both markers
- `extractFormSchema()` correctly extracts JSON from markdown code blocks
- Parse errors return found: true, valid: false with error message
- Valid schemas return found: true, valid: true with schema data
- Missing schemas return found: false
  </done>
</task>

</tasks>

<verification>
- [ ] `schema-extraction.ts` exports `extractFormSchema`, `mightContainSchema`, `SchemaExtractionResult`
- [ ] Correctly handles: no schema, valid schema, invalid JSON, schema validation failures
- [ ] No runtime errors when imported
</verification>

<success_criteria>
Schema extraction utility ready for use in wizard integration (Plan 02/03)
</success_criteria>

<output>
After completion, create `.planning/phases/27-form-generation-preview/27-01-SUMMARY.md`
</output>

---
phase: 27-form-generation-preview
plan: 03
type: execute
wave: 3
depends_on: [27-01, 27-02]
files_modified:
  - src/components/ai-wizard/AIFormWizard.tsx
  - src/components/ai-wizard/steps/PreviewStep.tsx
  - src/components/ai-wizard/steps/ChatStep.tsx
autonomous: false

must_haves:
  truths:
    - "When AI response contains valid schema, wizard transitions to preview step"
    - "Preview displays using FormPreviewPanel with accurate field rendering"
    - "Regenerate sends new message asking for alternative structure"
    - "Modify Prompt returns to chat for user to type new instructions"
    - "Direct-to-draft toggle skips preview when enabled"
  artifacts:
    - path: "src/components/ai-wizard/AIFormWizard.tsx"
      provides: "Wizard with schema detection and preview step"
      contains: "generatedSchema"
    - path: "src/components/ai-wizard/steps/PreviewStep.tsx"
      provides: "Preview step wrapper with action handlers"
      min_lines: 50
  key_links:
    - from: "src/components/ai-wizard/AIFormWizard.tsx"
      to: "src/components/ai-wizard/schema-extraction.ts"
      via: "extractFormSchema in useEffect"
      pattern: "extractFormSchema"
    - from: "src/components/ai-wizard/steps/PreviewStep.tsx"
      to: "src/components/ai-wizard/FormPreviewPanel.tsx"
      via: "renders FormPreviewPanel"
      pattern: "FormPreviewPanel"
---

<objective>
Integrate schema detection and preview step into AI wizard flow

Purpose: Complete the form generation UX - from chat to preview with iteration options
Output: Working wizard that detects AI-generated schemas and shows preview before form creation
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-form-generation-preview/27-RESEARCH.md
@.planning/phases/27-form-generation-preview/27-01-SUMMARY.md
@.planning/phases/27-form-generation-preview/27-02-SUMMARY.md

# Key files for this plan
@src/components/ai-wizard/AIFormWizard.tsx
@src/components/ai-wizard/steps/ChatStep.tsx
@src/components/ai-wizard/schema-extraction.ts
@src/components/ai-wizard/FormPreviewPanel.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PreviewStep component</name>
  <files>src/components/ai-wizard/steps/PreviewStep.tsx</files>
  <action>
Create `src/components/ai-wizard/steps/PreviewStep.tsx`:

This component wraps FormPreviewPanel and handles the preview step UI including header and back navigation.

```typescript
'use client';

import { Button } from '@/components/ui/button';
import { ArrowLeft, Sparkles } from 'lucide-react';
import { FormPreviewPanel } from '../FormPreviewPanel';
import type { AIFormSchemaOutput } from '@/lib/ai/schemas';

interface PreviewStepProps {
  schema: AIFormSchemaOutput;
  onAccept: () => void;
  onRegenerate: () => void;
  onModifyPrompt: () => void;
  onBack: () => void;
}

export function PreviewStep({
  schema,
  onAccept,
  onRegenerate,
  onModifyPrompt,
  onBack,
}: PreviewStepProps) {
  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-start justify-between">
        <div className="space-y-1">
          <div className="flex items-center gap-2">
            <Sparkles className="h-5 w-5 text-primary" />
            <h2 className="text-xl font-semibold">AI Generated Form</h2>
          </div>
          <p className="text-sm text-muted-foreground">
            Review the generated form structure. You can regenerate or modify before using.
          </p>
        </div>
        <Button variant="ghost" size="sm" onClick={onBack}>
          <ArrowLeft className="h-4 w-4 mr-1" />
          Back to Chat
        </Button>
      </div>

      {/* Preview Panel */}
      <FormPreviewPanel
        schema={schema}
        onAccept={onAccept}
        onRegenerate={onRegenerate}
        onModifyPrompt={onModifyPrompt}
      />
    </div>
  );
}
```
  </action>
  <verify>
TypeScript compiles:
```bash
cd /Users/memehalis/ft-form && npx tsc --noEmit src/components/ai-wizard/steps/PreviewStep.tsx
```
  </verify>
  <done>
- PreviewStep wraps FormPreviewPanel with header and back navigation
- All action handlers properly passed through
  </done>
</task>

<task type="auto">
  <name>Task 2: Update AIFormWizard with schema detection and preview step</name>
  <files>src/components/ai-wizard/AIFormWizard.tsx</files>
  <action>
Update `src/components/ai-wizard/AIFormWizard.tsx` with the following changes:

1. **Add imports:**
   - `extractFormSchema, mightContainSchema` from `./schema-extraction`
   - `PreviewStep` from `./steps/PreviewStep`
   - `AIFormSchemaOutput` type from `@/lib/ai/schemas`
   - `useEffect` to React imports

2. **Update WizardStep type:**
   ```typescript
   export type WizardStep = 'form-type' | 'audience' | 'chat' | 'preview';
   ```
   Remove 'generating' - we replace it with 'preview'

3. **Update WizardState interface:**
   ```typescript
   export interface WizardState {
     step: WizardStep;
     formType: FormType | null;
     audience: Audience | null;
     directToDraft: boolean;  // NEW: PRV-05 requirement
   }
   ```
   Initialize `directToDraft: false` in initial state

4. **Add new state:**
   ```typescript
   const [generatedSchema, setGeneratedSchema] = useState<AIFormSchemaOutput | null>(null);
   const [schemaErrors, setSchemaErrors] = useState<string[] | null>(null);
   ```

5. **Add schema detection effect:**
   ```typescript
   // Detect schema in AI responses
   useEffect(() => {
     // Only check when ready (stream complete)
     if (status !== 'ready' || messages.length === 0) return;

     const lastAssistantMessage = messages
       .filter((m) => m.role === 'assistant')
       .at(-1);

     if (!lastAssistantMessage) return;

     // Extract text content from parts (AI SDK v6 pattern)
     const content = lastAssistantMessage.parts
       ?.filter((p): p is { type: 'text'; text: string } => p.type === 'text')
       .map((p) => p.text)
       .join('') || '';

     // Quick pre-check to avoid expensive parsing
     if (!mightContainSchema(content)) return;

     const result = extractFormSchema(content);

     if (result.found) {
       if (result.valid && result.schema) {
         setGeneratedSchema(result.schema);
         setSchemaErrors(null);

         // Check direct-to-draft preference
         if (wizard.directToDraft) {
           // Skip preview, call onComplete directly
           onComplete(result.schema);
         } else {
           // Show preview
           setWizard((prev) => ({ ...prev, step: 'preview' }));
         }
       } else if (result.errors) {
         setSchemaErrors(result.errors);
         // Stay on chat, errors will be shown
       }
     }
   }, [messages, status, wizard.directToDraft, onComplete]);
   ```

6. **Add regeneration handler:**
   ```typescript
   const handleRegenerate = () => {
     // Send message requesting alternative structure
     sendMessage({
       text: 'Please generate an alternative form structure for the same requirements, with different step groupings or field arrangements.',
     });
     // Clear schema state and return to chat
     setGeneratedSchema(null);
     setSchemaErrors(null);
     setWizard((prev) => ({ ...prev, step: 'chat' }));
   };
   ```

7. **Add modify prompt handler:**
   ```typescript
   const handleModifyPrompt = () => {
     // Return to chat without clearing messages - user can type new instructions
     setGeneratedSchema(null);
     setSchemaErrors(null);
     setWizard((prev) => ({ ...prev, step: 'chat' }));
   };
   ```

8. **Add accept handler:**
   ```typescript
   const handleAcceptSchema = () => {
     if (generatedSchema) {
       onComplete(generatedSchema);
     }
   };
   ```

9. **Update handleBack for preview step:**
   ```typescript
   } else if (wizard.step === 'preview') {
     setWizard((prev) => ({ ...prev, step: 'chat' }));
   }
   ```

10. **Update render to show preview step (replace generating step):**
    ```typescript
    {wizard.step === 'preview' && generatedSchema && (
      <PreviewStep
        schema={generatedSchema}
        onAccept={handleAcceptSchema}
        onRegenerate={handleRegenerate}
        onModifyPrompt={handleModifyPrompt}
        onBack={handleBack}
      />
    )}
    ```

11. **Remove GeneratingStep import and render block** - no longer needed

12. **Pass schemaErrors to ChatStep** (optional enhancement):
    Add `schemaErrors` prop to ChatStep to display validation errors inline if needed.
    If ChatStep doesn't handle it yet, just log errors for now: `console.warn('Schema errors:', schemaErrors)`

13. **Remove the `void onComplete;` line** - it's now properly used
  </action>
  <verify>
TypeScript compiles and lint passes:
```bash
cd /Users/memehalis/ft-form && npx tsc --noEmit && pnpm lint --quiet
```
  </verify>
  <done>
- WizardStep type updated to include 'preview' (removed 'generating')
- Schema detection effect monitors messages and transitions to preview
- Direct-to-draft support: when enabled, skips preview and calls onComplete directly
- Regenerate sends new message and returns to chat
- Modify prompt returns to chat without clearing messages
- Accept calls onComplete with generated schema
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Direct-to-Draft toggle to ChatStep</name>
  <files>src/components/ai-wizard/steps/ChatStep.tsx</files>
  <action>
Update `src/components/ai-wizard/steps/ChatStep.tsx` to include a direct-to-draft toggle (PRV-05):

1. **Add new props:**
   ```typescript
   interface ChatStepProps {
     // ... existing props
     directToDraft: boolean;
     onDirectToDraftChange: (value: boolean) => void;
   }
   ```

2. **Add toggle UI** below the context banner (before messages), styled subtly:
   ```typescript
   import { Switch } from '@/components/ui/switch';
   import { Label } from '@/components/ui/label';

   // In the render, after context banner:
   <div className="flex items-center justify-end gap-2 text-sm">
     <Label htmlFor="direct-draft" className="text-muted-foreground cursor-pointer">
       Skip preview
     </Label>
     <Switch
       id="direct-draft"
       checked={directToDraft}
       onCheckedChange={onDirectToDraftChange}
     />
   </div>
   ```

3. **Update AIFormWizard.tsx** to pass these props:
   ```typescript
   <ChatStep
     // ... existing props
     directToDraft={wizard.directToDraft}
     onDirectToDraftChange={(value) =>
       setWizard((prev) => ({ ...prev, directToDraft: value }))
     }
   />
   ```

The toggle allows confident users to skip the preview step entirely - when enabled, successful schema generation immediately calls onComplete.
  </action>
  <verify>
TypeScript compiles:
```bash
cd /Users/memehalis/ft-form && npx tsc --noEmit src/components/ai-wizard/steps/ChatStep.tsx
```
  </verify>
  <done>
- Direct-to-draft toggle visible in ChatStep
- Toggle state flows through to schema detection logic
- When enabled, valid schema skips preview and goes to form creation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete form generation and preview flow:
- Schema detection from AI responses
- Form preview panel with step navigation
- Regenerate and Modify Prompt iteration options
- Direct-to-draft toggle for confident users
  </what-built>
  <how-to-verify>
1. Start dev server: `pnpm dev`
2. Navigate to http://localhost:3000/admin/forms/new/ai
3. Enter your OpenRouter API key (sk-or-...)
4. Select form type (e.g., "Application")
5. Select audience (e.g., "External")
6. In chat, describe a form: "Create a simple contact form with name, email, and message fields"
7. AI will ask clarifying questions - answer them
8. When AI outputs form schema (```json block), wizard should auto-transition to preview
9. Verify in preview:
   - [ ] Form fields render correctly (text inputs, etc.)
   - [ ] Step navigation works (if multiple steps)
   - [ ] Mobile/Desktop toggle changes preview width
   - [ ] Stats show correct step/field counts
   - [ ] "Regenerate" returns to chat and sends new message
   - [ ] "Modify Prompt" returns to chat (no new message)
   - [ ] "Use This Form" calls onComplete (may show error since Phase 28 implements creation)
10. Test Direct-to-Draft:
    - [ ] Toggle visible in chat step ("Skip preview")
    - [ ] When enabled, schema detection skips preview
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- [ ] Schema detected from AI response and wizard transitions to preview
- [ ] Preview renders fields using DynamicField components
- [ ] Step navigation works in preview
- [ ] Mobile/Desktop toggle works
- [ ] Regenerate sends message and returns to chat
- [ ] Modify Prompt returns to chat without message
- [ ] Direct-to-draft toggle skips preview when enabled
- [ ] Human verification approved
</verification>

<success_criteria>
Complete Phase 27: Users can generate forms via AI chat, preview them, and iterate before creation
</success_criteria>

<output>
After completion, create `.planning/phases/27-form-generation-preview/27-03-SUMMARY.md`
</output>

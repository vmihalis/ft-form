---
phase: 18-export
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/csv-export.ts
  - src/components/admin/StatusFilter.tsx
  - src/components/admin/DateRangeFilter.tsx
  - src/components/admin/SubmissionsFilters.tsx
  - src/components/admin/SubmissionsTable.tsx
  - src/components/admin/submissions-columns.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can filter submissions by status (New, Under Review, Accepted, Rejected, All)"
    - "Admin can filter submissions by date range (start date, end date)"
    - "Filters affect which rows display in the table"
    - "Build passes with no TypeScript errors"
  artifacts:
    - path: "src/lib/csv-export.ts"
      provides: "CSV generation utilities with RFC 4180 escaping"
      exports: ["escapeCSVField", "generateCSV", "downloadCSV"]
    - path: "src/components/admin/StatusFilter.tsx"
      provides: "Status dropdown filter component"
      exports: ["StatusFilter"]
    - path: "src/components/admin/DateRangeFilter.tsx"
      provides: "Date range filter component"
      exports: ["DateRangeFilter"]
    - path: "src/components/admin/SubmissionsFilters.tsx"
      provides: "Combined filter bar component"
      exports: ["SubmissionsFilters"]
    - path: "src/components/admin/SubmissionsTable.tsx"
      provides: "Table with integrated filters"
      contains: "SubmissionsFilters"
  key_links:
    - from: "src/components/admin/SubmissionsTable.tsx"
      to: "src/components/admin/SubmissionsFilters.tsx"
      via: "component composition"
      pattern: "<SubmissionsFilters"
    - from: "src/components/admin/SubmissionsFilters.tsx"
      to: "src/components/admin/StatusFilter.tsx"
      via: "component composition"
      pattern: "<StatusFilter"
    - from: "src/components/admin/SubmissionsTable.tsx"
      to: "@tanstack/react-table"
      via: "column filter state"
      pattern: "setColumnFilters"
---

<objective>
Create CSV export utility and add status/date range filters to the submissions table.

Purpose: EXPORT-01 and EXPORT-02 require filtering before export. This plan establishes the filter infrastructure and CSV generation utility. Plan 02 will add the export button that uses filtered rows.

Output: Working filter UI (status dropdown, date range inputs) integrated with TanStack Table, plus CSV utility ready for export.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-export/18-RESEARCH.md

@src/components/admin/SubmissionsTable.tsx
@src/components/admin/submissions-columns.tsx
@src/components/admin/FormFilter.tsx
@src/types/form-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV export utility</name>
  <files>src/lib/csv-export.ts</files>
  <action>
Create a new file `src/lib/csv-export.ts` with RFC 4180-compliant CSV generation utilities.

The file should export three functions:

1. `escapeCSVField(value: unknown): string`
   - Convert value to string (null/undefined -> empty string)
   - If string contains comma, quote, newline, or carriage return: wrap in double quotes and escape internal quotes by doubling them
   - Otherwise return as-is

2. `generateCSV(data: Record<string, unknown>[], headers: { key: string; label: string }[]): string`
   - Build header row from labels (escaped)
   - Build data rows by mapping each record through headers (escaped)
   - Prepend UTF-8 BOM ('\ufeff') for Excel compatibility
   - Use CRLF line endings per RFC 4180
   - Return complete CSV string

3. `downloadCSV(csvContent: string, filename: string): void`
   - Create Blob with type 'text/csv;charset=utf-8'
   - Create Object URL
   - Create anchor element, set href and download attribute
   - Append to body, click, remove from body
   - Revoke Object URL to prevent memory leak

Include TypeScript types. No external dependencies - pure JavaScript/browser APIs only.

Example usage (for documentation comment):
```typescript
const data = [{ name: 'John', email: 'john@example.com' }];
const headers = [{ key: 'name', label: 'Full Name' }, { key: 'email', label: 'Email Address' }];
const csv = generateCSV(data, headers);
downloadCSV(csv, 'export.csv');
```
  </action>
  <verify>
1. File exists: `ls src/lib/csv-export.ts`
2. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>csv-export.ts exports escapeCSVField, generateCSV, and downloadCSV functions with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Create filter components</name>
  <files>
    src/components/admin/StatusFilter.tsx
    src/components/admin/DateRangeFilter.tsx
    src/components/admin/SubmissionsFilters.tsx
  </files>
  <action>
Create three new components following existing patterns (see FormFilter.tsx for reference).

**StatusFilter.tsx:**
- Props: `value: string, onValueChange: (value: string) => void`
- Use shadcn Select component (same pattern as FormFilter)
- Options: "all" (All Statuses), "new" (New), "under_review" (Under Review), "accepted" (Accepted), "rejected" (Rejected)
- Trigger width: w-[180px]
- Placeholder: "Filter by status"

**DateRangeFilter.tsx:**
- Props: `startDate: string, endDate: string, onStartDateChange: (value: string) => void, onEndDateChange: (value: string) => void`
- Two native date inputs (Input component with type="date")
- Layout: flex with gap-2, "to" text between inputs
- Input widths: w-[150px]
- Include aria-labels for accessibility

**SubmissionsFilters.tsx:**
Combines all filters into a single row component.
- Props:
  ```typescript
  interface SubmissionsFiltersProps {
    formFilter: string;
    onFormFilterChange: (value: string) => void;
    statusFilter: string;
    onStatusFilterChange: (value: string) => void;
    startDate: string;
    endDate: string;
    onStartDateChange: (value: string) => void;
    onEndDateChange: (value: string) => void;
    searchValue: string;
    onSearchChange: (e: React.ChangeEvent<HTMLInputElement>) => void;
  }
  ```
- Layout: `flex flex-wrap gap-4 items-center`
- Order: FormFilter, StatusFilter, DateRangeFilter, SearchInput
- Import and use FormFilter (existing), StatusFilter (new), DateRangeFilter (new), SearchInput (existing)
  </action>
  <verify>
1. Files exist: `ls src/components/admin/{StatusFilter,DateRangeFilter,SubmissionsFilters}.tsx`
2. TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>Three filter components created: StatusFilter (dropdown), DateRangeFilter (date inputs), SubmissionsFilters (combined bar)</done>
</task>

<task type="auto">
  <name>Task 3: Integrate filters with SubmissionsTable</name>
  <files>
    src/components/admin/SubmissionsTable.tsx
    src/components/admin/submissions-columns.tsx
  </files>
  <action>
Update SubmissionsTable to use the new SubmissionsFilters component and add date range filtering.

**submissions-columns.tsx changes:**
Add a custom filter function for submittedAt column that handles date range:
```typescript
filterFn: (row, id, filterValue) => {
  if (!filterValue) return true;
  const { start, end } = filterValue as { start?: string; end?: string };
  const timestamp = row.getValue(id) as number;

  if (start) {
    const startTime = new Date(start).getTime();
    if (timestamp < startTime) return false;
  }
  if (end) {
    // End of day for end date (23:59:59.999)
    const endTime = new Date(end).getTime() + (24 * 60 * 60 * 1000 - 1);
    if (timestamp > endTime) return false;
  }
  return true;
},
```

**SubmissionsTable.tsx changes:**

1. Add state for status and date range filters:
```typescript
const [statusFilter, setStatusFilter] = useState("all");
const [startDate, setStartDate] = useState("");
const [endDate, setEndDate] = useState("");
```

2. Replace the current filter row (FormFilter + SearchInput) with SubmissionsFilters:
```typescript
<SubmissionsFilters
  formFilter={(table.getColumn("formName")?.getFilterValue() as string) ?? "all"}
  onFormFilterChange={handleFormFilter}
  statusFilter={statusFilter}
  onStatusFilterChange={handleStatusFilter}
  startDate={startDate}
  endDate={endDate}
  onStartDateChange={setStartDate}
  onEndDateChange={setEndDate}
  searchValue={globalFilter}
  onSearchChange={(e) => setGlobalFilter(e.target.value)}
/>
```

3. Add handlers for status and date filters:
```typescript
const handleStatusFilter = (value: string) => {
  setStatusFilter(value);
  table.getColumn("status")?.setFilterValue(value === "all" ? undefined : value);
};

// Date filter effect - update when dates change
useEffect(() => {
  const dateFilter = startDate || endDate ? { start: startDate, end: endDate } : undefined;
  table.getColumn("submittedAt")?.setFilterValue(dateFilter);
}, [startDate, endDate, table]);
```

4. Update imports to include SubmissionsFilters and useEffect
5. Remove direct imports of FormFilter and SearchInput (now via SubmissionsFilters)
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Run `npm run dev` and verify at /admin:
   - Status filter dropdown appears and filters table
   - Date range inputs appear and filter table
   - Form filter still works
   - Search still works
  </verify>
  <done>SubmissionsTable shows all filters (form, status, date range, search) and filtering works correctly</done>
</task>

</tasks>

<verification>
1. `npm run build` completes successfully
2. All new files exist in expected locations
3. Status filter changes which submissions display
4. Date range filter correctly includes/excludes submissions
5. All filters can be combined (e.g., "New" status + "this week" date range + "Floor Lead" form)
6. No TypeScript errors
7. No console errors at runtime
</verification>

<success_criteria>
- CSV utility is ready for use (will be used by export button in Plan 02)
- Admin can filter submissions by status using dropdown
- Admin can filter submissions by date range using date inputs
- Filters integrate with existing form filter and search
- All filters can be combined
- TanStack Table filtering works correctly with all filter types
</success_criteria>

<output>
After completion, create `.planning/phases/18-export/18-01-SUMMARY.md`
</output>

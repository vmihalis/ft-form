---
phase: 26-chat-ui-conversation-flow
plan: 03
type: execute
wave: 3
depends_on: ["26-02"]
files_modified:
  - src/app/admin/forms/new/ai/page.tsx
  - src/components/ai-wizard/AIFormWizard.tsx
autonomous: false

must_haves:
  truths:
    - "AI wizard is accessible at /admin/forms/new/ai"
    - "Wizard handles API key input from user"
    - "Full flow works: form-type -> audience -> chat -> streaming response"
    - "Cancel and back navigation work throughout"
  artifacts:
    - path: "src/app/admin/forms/new/ai/page.tsx"
      provides: "Page route for AI form wizard"
      min_lines: 30
  key_links:
    - from: "page.tsx"
      to: "AIFormWizard.tsx"
      via: "renders wizard component"
      pattern: "AIFormWizard"
---

<objective>
Create the page route for the AI wizard and add API key input, then verify the complete flow.

Purpose: Complete the Phase 26 deliverable by mounting the wizard at an accessible URL and ensuring the full user flow works end-to-end. This plan includes human verification since the wizard is a visual, interactive component.

Output: Working AI form wizard at /admin/forms/new/ai with verified user flow.
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-chat-ui-conversation-flow/26-RESEARCH.md
@.planning/phases/26-chat-ui-conversation-flow/26-01-SUMMARY.md
@.planning/phases/26-chat-ui-conversation-flow/26-02-SUMMARY.md

# Wizard components
@src/components/ai-wizard/AIFormWizard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AI Wizard Page Route</name>
  <files>
    src/app/admin/forms/new/ai/page.tsx
  </files>
  <action>
Create the Next.js page route for the AI form creation wizard.

**page.tsx:**
- 'use client' directive
- Import AIFormWizard from '@/components/ai-wizard/AIFormWizard'
- Import useState from 'react'
- Import { useRouter } from 'next/navigation'
- Import Input from '@/components/ui/input'
- Import Button from '@/components/ui/button'
- Import Card, CardContent, CardDescription, CardHeader, CardTitle from '@/components/ui/card'

**State:**
- apiKey: string (empty initially)
- hasEnteredKey: boolean (false initially)
- For MVP, store apiKey in component state (not localStorage for security)

**Layout:**
- If !hasEnteredKey: Show API key entry form
  - Card with title "Enter Your OpenRouter API Key"
  - Description explaining user needs their own key
  - Input type="password" for API key
  - Link to "Get an API key at openrouter.ai" (opens in new tab)
  - Continue button (disabled if key empty or doesn't start with "sk-or-")
  - On continue: setHasEnteredKey(true)
- If hasEnteredKey: Render AIFormWizard with:
  - apiKey={apiKey}
  - onComplete={(schema) => { /* Phase 27 will handle preview */ console.log('Generated:', schema); }}
  - onCancel={() => router.push('/admin/forms')}

**Page title:** "Create Form with AI"
  </action>
  <verify>
    `pnpm build` passes. Navigate to /admin/forms/new/ai shows API key entry (after auth).
  </verify>
  <done>
    AI wizard page accessible at /admin/forms/new/ai. Shows API key entry first, then wizard after key entered.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Generating Step Placeholder</name>
  <files>
    src/components/ai-wizard/AIFormWizard.tsx
    src/components/ai-wizard/steps/GeneratingStep.tsx
  </files>
  <action>
Add the generating step placeholder for when AI is producing the form schema. Full implementation in Phase 27.

**GeneratingStep.tsx:**
- Props: { messages: UIMessage[], status: string, onCancel: () => void }
- Simple card showing:
  - Title: "Generating Your Form..."
  - Description: "AI is creating your form based on the conversation."
  - Spinner or animated skeleton
  - Cancel button
- This is a placeholder - Phase 27 will add actual form preview

**AIFormWizard.tsx changes:**
- Import GeneratingStep
- Add conditional render for wizard.step === 'generating'
- For now, transition to 'generating' step is not automatic (Phase 27 will detect form schema in stream and trigger transition)
- Add placeholder in render: just show GeneratingStep when step is 'generating'
  </action>
  <verify>
    `pnpm build` passes. GeneratingStep component exists and is imported in AIFormWizard.
  </verify>
  <done>
    Generating step placeholder exists. Phase 27 will implement form schema detection and preview.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete AI Form Wizard with:
    - API key entry page at /admin/forms/new/ai
    - 4-step wizard: Form Type -> Audience -> Chat -> Generating
    - Form type selection (5 options)
    - Audience selection (External/Internal)
    - Chat interface with streaming AI responses
    - Typing indicator during AI response
    - Stop button to cancel streaming
    - Error handling with retry
    - Back navigation preserving selections
  </what-built>
  <how-to-verify>
    1. Start dev server: `pnpm dev`
    2. Navigate to http://localhost:3000/admin/forms/new/ai (login if prompted)
    3. **API Key Entry:**
       - Should see API key input form
       - Continue button disabled until valid key format (sk-or-...)
       - Enter your OpenRouter API key and click Continue
    4. **Form Type Step:**
       - Should see 5 form type options with icons
       - Click "Application" - should highlight and advance
    5. **Audience Step:**
       - Should see External/Internal options
       - Click Back - should return to Form Type with Application still selected
       - Click Continue on Audience - should advance to Chat
    6. **Chat Step:**
       - Should see context banner showing "application" and "external"
       - Type "I need a job application form" and send
       - Should see typing indicator while AI responds
       - Should see AI response stream in
       - AI should ask clarifying questions (not immediately generate form)
    7. **Cancel Test:**
       - Send another message
       - While AI is responding, click Stop
       - Stream should stop, conversation preserved
    8. **Error Recovery (optional):**
       - If you have access to invalid key, test error shows retry button

    Report any issues with the flow.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks:
1. AI wizard accessible at /admin/forms/new/ai
2. API key entry required before wizard
3. Full wizard flow: form-type -> audience -> chat -> (generating placeholder)
4. Human verified all interactions work correctly
</verification>

<success_criteria>
- **AI-01**: System accepts natural language prompts (chat step works)
- **AI-03**: AI responses stream to client with typing indicator
- **HYB-01**: Before open prompt, user selects form type
- **HYB-02**: User selects audience (External/Internal)
- **HYB-03**: Structured selections inform AI context (context banner + API body)
- **HYB-04**: AI asks 2-3 clarifying questions (system prompt instruction)
- **UX-02**: AI wizard has clear visual state (step indicator)
- **UX-03**: Streaming responses show progress (typing indicator)
- **UX-04**: Cancel available during generation (stop button)
- **UX-05**: Errors recoverable without losing context (retry preserves messages)
</success_criteria>

<output>
After completion, create `.planning/phases/26-chat-ui-conversation-flow/26-03-SUMMARY.md`
</output>

---
phase: 11-schema-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/types/form-schema.ts
  - convex/schema.ts
autonomous: true

must_haves:
  truths:
    - "FormSchema TypeScript types exist and can be imported"
    - "Convex schema defines forms, formVersions, submissions, submissionEditHistory tables"
    - "Schema compiles without errors via npx convex dev"
  artifacts:
    - path: "src/types/form-schema.ts"
      provides: "TypeScript types for form schema (FormSchema, FormField, FormStep, FieldType, etc.)"
      exports: ["FormSchema", "FormStep", "FormField", "FieldType", "FieldValidation", "FieldOption", "FormSettings"]
    - path: "convex/schema.ts"
      provides: "Convex database schema with new tables for dynamic forms"
      contains: ["forms:", "formVersions:", "submissions:", "submissionEditHistory:"]
  key_links:
    - from: "src/types/form-schema.ts"
      to: "convex/schema.ts"
      via: "JSON string storage pattern - FormSchema serialized as string in draftSchema/schema fields"
      pattern: "draftSchema.*v\\.string\\(\\)"
---

<objective>
Create TypeScript type definitions and Convex database schema for dynamic forms with versioning.

Purpose: Establish the data foundation that all subsequent form builder phases depend on. Without these types and tables, no form CRUD or rendering can be built.

Output:
- `src/types/form-schema.ts` - TypeScript interfaces for form structure
- `convex/schema.ts` - Extended with 4 new tables (forms, formVersions, submissions, submissionEditHistory)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-schema-foundation/11-RESEARCH.md
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TypeScript type definitions for form schema</name>
  <files>src/types/form-schema.ts</files>
  <action>
Create a new file `src/types/form-schema.ts` with the following TypeScript interfaces:

```typescript
// Form schema types for dynamic form builder

export interface FormSchema {
  steps: FormStep[];
  settings: FormSettings;
}

export interface FormStep {
  id: string;                     // Unique step identifier (e.g., "step_1")
  title: string;
  description?: string;
  fields: FormField[];
}

export interface FormField {
  id: string;                     // Unique field identifier (key for responses)
  type: FieldType;
  label: string;
  description?: string;
  placeholder?: string;
  required: boolean;
  validation?: FieldValidation;
  options?: FieldOption[];        // For select, radio, checkbox
}

export type FieldType =
  | "text"
  | "email"
  | "url"
  | "textarea"
  | "number"
  | "date"
  | "select"
  | "radio"
  | "checkbox"
  | "file";

export interface FieldValidation {
  minLength?: number;
  maxLength?: number;
  min?: number;                   // For number fields
  max?: number;                   // For number fields
  pattern?: string;               // Regex pattern
  customMessage?: string;         // Custom error message
}

export interface FieldOption {
  value: string;
  label: string;
}

export interface FormSettings {
  submitButtonText: string;
  successMessage: string;
}

// Convex document types (what comes from database queries)
export interface FormDoc {
  _id: string;
  _creationTime: number;
  name: string;
  slug: string;
  description?: string;
  status: "draft" | "published" | "archived";
  draftSchema: string;            // JSON.stringify(FormSchema)
  currentVersionId?: string;
  createdAt: number;
  updatedAt: number;
}

export interface FormVersionDoc {
  _id: string;
  _creationTime: number;
  formId: string;
  version: number;
  schema: string;                 // JSON.stringify(FormSchema) - IMMUTABLE
  publishedAt: number;
}

export interface SubmissionDoc {
  _id: string;
  _creationTime: number;
  formVersionId: string;
  data: string;                   // JSON.stringify({ [fieldId]: value })
  status: "new" | "under_review" | "accepted" | "rejected";
  submittedAt: number;
}

export interface SubmissionEditHistoryDoc {
  _id: string;
  _creationTime: number;
  submissionId: string;
  fieldId: string;                // Field ID from schema
  fieldLabel: string;             // Human-readable label at edit time
  oldValue: string;
  newValue: string;
  editedAt: number;
}
```

Ensure no default export - use named exports only for tree-shaking.
  </action>
  <verify>
Run TypeScript compiler check:
```bash
npx tsc --noEmit src/types/form-schema.ts
```
Should complete with no errors.
  </verify>
  <done>
- File `src/types/form-schema.ts` exists
- All interfaces exported: FormSchema, FormStep, FormField, FieldType, FieldValidation, FieldOption, FormSettings, FormDoc, FormVersionDoc, SubmissionDoc, SubmissionEditHistoryDoc
- TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend Convex schema with dynamic form tables</name>
  <files>convex/schema.ts</files>
  <action>
Update `convex/schema.ts` to add four new tables while preserving existing `applications` and `editHistory` tables.

Add after the existing `editHistory` table:

```typescript
// Dynamic Form Builder Tables (v1.2)

// Form definition (editable by admin)
forms: defineTable({
  name: v.string(),                    // "Floor Lead Application 2024"
  slug: v.string(),                    // URL path: "floor-lead-2024" -> /apply/floor-lead-2024
  description: v.optional(v.string()), // Internal admin description
  status: v.union(
    v.literal("draft"),
    v.literal("published"),
    v.literal("archived")
  ),
  draftSchema: v.string(),             // JSON.stringify(FormSchema) - mutable draft
  currentVersionId: v.optional(v.id("formVersions")), // Reference to published version
  createdAt: v.number(),
  updatedAt: v.number(),
})
  .index("by_slug", ["slug"])
  .index("by_status", ["status"]),

// Immutable version snapshot (created on publish)
formVersions: defineTable({
  formId: v.id("forms"),
  version: v.number(),                 // 1, 2, 3...
  schema: v.string(),                  // JSON.stringify(FormSchema) - IMMUTABLE
  publishedAt: v.number(),
})
  .index("by_form", ["formId"])
  .index("by_form_version", ["formId", "version"]),

// Dynamic submissions (separate from legacy applications)
submissions: defineTable({
  formVersionId: v.id("formVersions"), // Links to immutable version, NOT form
  data: v.string(),                    // JSON.stringify({ [fieldId]: value })
  status: v.union(
    v.literal("new"),
    v.literal("under_review"),
    v.literal("accepted"),
    v.literal("rejected")
  ),
  submittedAt: v.number(),
})
  .index("by_version", ["formVersionId"])
  .index("by_status", ["status"])
  .index("by_submitted", ["submittedAt"]),

// Edit history for dynamic submissions
submissionEditHistory: defineTable({
  submissionId: v.id("submissions"),
  fieldId: v.string(),                 // Field ID from schema
  fieldLabel: v.string(),              // Human-readable label at edit time
  oldValue: v.string(),
  newValue: v.string(),
  editedAt: v.number(),
})
  .index("by_submission", ["submissionId", "editedAt"]),
```

IMPORTANT:
- DO NOT modify or remove the existing `applications` or `editHistory` tables
- Keep all existing indexes intact
- Add the new tables at the end of the defineSchema call
  </action>
  <verify>
Run Convex schema push to validate:
```bash
npx convex dev --once
```
Should complete without schema validation errors. New tables should appear in Convex dashboard.
  </verify>
  <done>
- `convex/schema.ts` contains forms, formVersions, submissions, submissionEditHistory tables
- Existing applications and editHistory tables unchanged
- All indexes defined: by_slug, by_status, by_form, by_form_version, by_version, by_submitted, by_submission
- Schema validates and pushes successfully with `npx convex dev`
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. TypeScript types compile: `npx tsc --noEmit`
2. Convex schema validates: `npx convex dev --once`
3. No regressions in existing tables (applications, editHistory still work)

Run existing test or smoke check if available:
```bash
npm run lint
```
</verification>

<success_criteria>
- [ ] `src/types/form-schema.ts` exists with all required interfaces
- [ ] `convex/schema.ts` has 6 tables total (2 legacy + 4 new)
- [ ] TypeScript compilation passes
- [ ] Convex schema push succeeds
- [ ] Legacy tables unchanged and still functional
</success_criteria>

<output>
After completion, create `.planning/phases/11-schema-foundation/11-01-SUMMARY.md`
</output>

---
phase: 22-wysiwyg-form-builder
plan: 02
type: execute
wave: 2
depends_on: ["22-01"]
files_modified:
  - src/components/form-builder/WysiwygField.tsx
  - src/components/form-builder/FieldToolbar.tsx
autonomous: true

must_haves:
  truths:
    - "Field renders actual form input appearance (WYSIWYG)"
    - "Clicking field shows floating toolbar with edit/delete/duplicate actions"
    - "Field has drag handle for reordering"
    - "Selected field has visible ring indicator"
  artifacts:
    - path: "src/components/form-builder/WysiwygField.tsx"
      provides: "Selectable field wrapper with WYSIWYG rendering"
      contains: "DynamicField"
      min_lines: 50
    - path: "src/components/form-builder/FieldToolbar.tsx"
      provides: "Floating toolbar with field actions"
      contains: "PopoverContent"
      exports: ["FieldToolbar"]
  key_links:
    - from: "src/components/form-builder/WysiwygField.tsx"
      to: "@/components/dynamic-form/fields"
      via: "DynamicField import"
      pattern: "DynamicField"
    - from: "src/components/form-builder/FieldToolbar.tsx"
      to: "@/lib/stores/form-builder-store"
      via: "useFormBuilderStore for actions"
      pattern: "removeField|duplicateField"
---

<objective>
Create WysiwygField and FieldToolbar components for WYSIWYG form building.

Purpose: Enable true WYSIWYG editing where fields appear exactly as users will see them, with floating toolbar for field operations.

Output: WysiwygField wraps DynamicField with selection state and drag support. FieldToolbar shows edit/delete/duplicate actions.
</objective>

<execution_context>
@/home/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/home/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-wysiwyg-form-builder/22-RESEARCH.md
@.planning/phases/22-wysiwyg-form-builder/22-01-SUMMARY.md

@src/components/dynamic-form/fields/index.tsx
@src/components/form-builder/SortableFieldCard.tsx
@src/lib/stores/form-builder-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FieldToolbar component</name>
  <files>src/components/form-builder/FieldToolbar.tsx</files>
  <action>
Create floating toolbar that appears when a field is selected:

```typescript
// src/components/form-builder/FieldToolbar.tsx
"use client";

import { Popover, PopoverContent, PopoverAnchor } from "@/components/ui/popover";
import { Tooltip, TooltipContent, TooltipTrigger, TooltipProvider } from "@/components/ui/tooltip";
import { Button } from "@/components/ui/button";
import { Edit2, Trash2, Copy } from "lucide-react";
import { useFormBuilderStore } from "@/lib/stores/form-builder-store";

interface FieldToolbarProps {
  fieldId: string;
}

export function FieldToolbar({ fieldId }: FieldToolbarProps) {
  const { removeField, duplicateField } = useFormBuilderStore();

  const handleDuplicate = () => {
    duplicateField(fieldId);
  };

  const handleDelete = () => {
    removeField(fieldId);
  };

  // Edit action: field is already selected, PropertyPanel shows.
  // Could optionally trigger inline editing mode in future.
  const handleEdit = () => {
    // Field is selected - PropertyPanel on right handles editing
    // This button is informational / could trigger inline focus
  };

  return (
    <Popover open={true}>
      <PopoverAnchor asChild>
        <div className="absolute inset-0 pointer-events-none" />
      </PopoverAnchor>
      <PopoverContent
        side="top"
        align="center"
        sideOffset={8}
        className="w-auto p-1 flex gap-1"
        onOpenAutoFocus={(e) => e.preventDefault()}
      >
        <TooltipProvider delayDuration={300}>
          <Tooltip>
            <TooltipTrigger asChild>
              <Button variant="ghost" size="icon" className="h-8 w-8" onClick={handleEdit}>
                <Edit2 className="h-4 w-4" />
              </Button>
            </TooltipTrigger>
            <TooltipContent>Edit in panel</TooltipContent>
          </Tooltip>

          <Tooltip>
            <TooltipTrigger asChild>
              <Button variant="ghost" size="icon" className="h-8 w-8" onClick={handleDuplicate}>
                <Copy className="h-4 w-4" />
              </Button>
            </TooltipTrigger>
            <TooltipContent>Duplicate field</TooltipContent>
          </Tooltip>

          <Tooltip>
            <TooltipTrigger asChild>
              <Button
                variant="ghost"
                size="icon"
                className="h-8 w-8 text-destructive hover:text-destructive"
                onClick={handleDelete}
              >
                <Trash2 className="h-4 w-4" />
              </Button>
            </TooltipTrigger>
            <TooltipContent>Delete field</TooltipContent>
          </Tooltip>
        </TooltipProvider>
      </PopoverContent>
    </Popover>
  );
}
```

Key implementation notes:
- Uses Popover with `open={true}` so it stays visible while field is selected
- PopoverAnchor is invisible overlay - actual field is the reference
- `onOpenAutoFocus` prevented to avoid stealing focus from field
- TooltipProvider wraps buttons for hover hints
- Edit button currently informational (PropertyPanel handles editing)
- Delete doesn't need confirmation in WYSIWYG context (undo would be better UX)
  </action>
  <verify>
- `ls src/components/form-builder/FieldToolbar.tsx` - file exists
- `grep "duplicateField" src/components/form-builder/FieldToolbar.tsx` - uses store action
- `grep "PopoverContent" src/components/form-builder/FieldToolbar.tsx` - uses popover
- `npx tsc --noEmit` - no TypeScript errors
  </verify>
  <done>
FieldToolbar component renders floating toolbar with edit/delete/duplicate actions using Popover and Tooltip.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create WysiwygField component</name>
  <files>src/components/form-builder/WysiwygField.tsx</files>
  <action>
Create selectable field wrapper that renders actual DynamicField:

```typescript
// src/components/form-builder/WysiwygField.tsx
"use client";

import { useSortable } from "@dnd-kit/sortable";
import { CSS } from "@dnd-kit/utilities";
import { GripVertical } from "lucide-react";
import { DynamicField } from "@/components/dynamic-form/fields";
import { FieldToolbar } from "./FieldToolbar";
import { useFormBuilderStore } from "@/lib/stores/form-builder-store";
import { cn } from "@/lib/utils";
import type { FormField } from "@/types/form-schema";

interface WysiwygFieldProps {
  field: FormField;
  stepIndex: number;
}

export function WysiwygField({ field, stepIndex }: WysiwygFieldProps) {
  const { selectedFieldId, selectField } = useFormBuilderStore();
  const isSelected = field.id === selectedFieldId;

  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging,
  } = useSortable({ id: field.id });

  const style = {
    transform: CSS.Transform.toString(transform),
    transition,
    opacity: isDragging ? 0.5 : 1,
  };

  return (
    <div
      ref={setNodeRef}
      style={style}
      className={cn(
        "relative group rounded-lg transition-all pl-8",
        "hover:ring-2 hover:ring-primary/30 hover:bg-muted/30",
        isSelected && "ring-2 ring-primary bg-muted/50"
      )}
      onClick={(e) => {
        e.stopPropagation();
        selectField(field.id);
      }}
    >
      {/* Drag handle - absolute positioned left */}
      <button
        type="button"
        className={cn(
          "absolute left-1 top-1/2 -translate-y-1/2",
          "opacity-0 group-hover:opacity-100",
          "cursor-grab active:cursor-grabbing p-1 rounded hover:bg-muted",
          "transition-opacity"
        )}
        {...attributes}
        {...listeners}
        onClick={(e) => e.stopPropagation()}
      >
        <GripVertical className="h-4 w-4 text-muted-foreground" />
      </button>

      {/* Actual form field - WYSIWYG rendering with pointer-events-none */}
      <div className="pointer-events-none py-2 pr-2">
        <DynamicField field={field} />
      </div>

      {/* Floating toolbar on selection */}
      {isSelected && <FieldToolbar fieldId={field.id} />}
    </div>
  );
}
```

Key implementation notes:
- Uses useSortable from @dnd-kit for drag-and-drop (same as SortableFieldCard)
- DynamicField wrapped in `pointer-events-none` to prevent accidental input
- Drag handle appears on hover (opacity transition)
- Click handler selects field, stopPropagation prevents deselection from parent
- Ring indicates selection state (ring-primary when selected)
- FieldToolbar conditionally rendered when selected
- Padding (pl-8) makes room for drag handle on left
  </action>
  <verify>
- `ls src/components/form-builder/WysiwygField.tsx` - file exists
- `grep "DynamicField" src/components/form-builder/WysiwygField.tsx` - imports DynamicField
- `grep "useSortable" src/components/form-builder/WysiwygField.tsx` - uses dnd-kit
- `grep "FieldToolbar" src/components/form-builder/WysiwygField.tsx` - renders toolbar
- `grep "pointer-events-none" src/components/form-builder/WysiwygField.tsx` - prevents input capture
- `npx tsc --noEmit` - no TypeScript errors
  </verify>
  <done>
WysiwygField component renders actual DynamicField with selection state, drag handle, and floating toolbar.
  </done>
</task>

</tasks>

<verification>
1. `ls src/components/form-builder/WysiwygField.tsx src/components/form-builder/FieldToolbar.tsx` - both files exist
2. `npx tsc --noEmit` - no TypeScript errors
3. Both components can be imported without errors
</verification>

<success_criteria>
- WysiwygField renders DynamicField (actual form input appearance)
- WysiwygField has drag handle visible on hover
- WysiwygField shows ring when selected
- FieldToolbar appears as floating popover when field is selected
- FieldToolbar has edit, duplicate, and delete actions with tooltips
- Clicking field selects it; clicking drag handle initiates drag
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/22-wysiwyg-form-builder/22-02-SUMMARY.md`
</output>

---
phase: 22-wysiwyg-form-builder
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/ui/popover.tsx
  - src/components/ui/tooltip.tsx
  - src/lib/stores/form-builder-store.ts
autonomous: true

must_haves:
  truths:
    - "Popover component available for floating UI elements"
    - "Tooltip component available for hover hints"
    - "Store supports adding field at specific index"
    - "Store supports duplicating a field"
  artifacts:
    - path: "src/components/ui/popover.tsx"
      provides: "Radix-based popover component"
      contains: "PopoverContent"
    - path: "src/components/ui/tooltip.tsx"
      provides: "Radix-based tooltip component"
      contains: "TooltipContent"
    - path: "src/lib/stores/form-builder-store.ts"
      provides: "Form builder state with WYSIWYG actions"
      exports: ["addFieldAtIndex", "duplicateField"]
  key_links:
    - from: "src/lib/stores/form-builder-store.ts"
      to: "nanoid"
      via: "ID generation for duplicated fields"
      pattern: "nanoid"
---

<objective>
Install shadcn popover and tooltip components, and enhance form-builder-store with WYSIWYG actions.

Purpose: Foundation components needed for floating toolbar and field type picker. Store enhancements enable insert-at-index and duplicate operations required by WYSIWYG builder.

Output: UI components ready for use, store with addFieldAtIndex and duplicateField actions.
</objective>

<execution_context>
@/home/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/home/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-wysiwyg-form-builder/22-RESEARCH.md

@src/lib/stores/form-builder-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install popover and tooltip components</name>
  <files>src/components/ui/popover.tsx, src/components/ui/tooltip.tsx</files>
  <action>
Run shadcn CLI to add popover and tooltip components:

```bash
npx shadcn@latest add popover tooltip -y
```

These components are required for:
- Floating toolbar (popover) that appears when a field is selected
- Field type picker (popover) that opens from plus button
- Hover hints (tooltip) on toolbar actions

Both use @radix-ui internally and match the project's existing shadcn pattern.
  </action>
  <verify>
Files exist and export expected components:
- `ls src/components/ui/popover.tsx` shows file exists
- `grep "PopoverContent" src/components/ui/popover.tsx` returns match
- `ls src/components/ui/tooltip.tsx` shows file exists
- `grep "TooltipContent" src/components/ui/tooltip.tsx` returns match
  </verify>
  <done>
Popover and Tooltip components installed via shadcn, available at @/components/ui/popover and @/components/ui/tooltip.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add store actions for WYSIWYG operations</name>
  <files>src/lib/stores/form-builder-store.ts</files>
  <action>
Enhance form-builder-store with two new actions needed for WYSIWYG builder:

1. **addFieldAtIndex(stepIndex, type, insertIndex)** - Insert field at specific position
   - Same as existing `addField` but uses splice to insert at `insertIndex` instead of push
   - Used by plus button between fields to insert at correct position

2. **duplicateField(fieldId)** - Copy a field with new ID
   - Find field by ID
   - Create deep copy with new nanoid()
   - Update label to indicate copy (e.g., "Field Name (Copy)")
   - Insert immediately after original field
   - Select the new field

Add to interface:
```typescript
interface FormBuilderState {
  // ... existing
  addFieldAtIndex: (stepIndex: number, type: FieldType, insertIndex: number) => void;
  duplicateField: (fieldId: string) => void;
}
```

Implementation notes:
- Use structuredClone or spread for deep copying field (handles options array)
- For duplicateField, find stepIndex and fieldIndex from getStepByFieldId
- Set isDirty: true and selectedFieldId to new field ID
  </action>
  <verify>
Type check passes and actions are accessible:
- `npx tsc --noEmit` passes without errors
- `grep "addFieldAtIndex" src/lib/stores/form-builder-store.ts` shows interface and implementation
- `grep "duplicateField" src/lib/stores/form-builder-store.ts` shows interface and implementation
  </verify>
  <done>
Store exports addFieldAtIndex and duplicateField actions. Both update isDirty and select the new field.
  </done>
</task>

</tasks>

<verification>
1. `ls src/components/ui/popover.tsx src/components/ui/tooltip.tsx` - both files exist
2. `npx tsc --noEmit` - no TypeScript errors
3. `grep -c "addFieldAtIndex\|duplicateField" src/lib/stores/form-builder-store.ts` - returns 4+ matches (interface + implementation each)
</verification>

<success_criteria>
- Popover and Tooltip shadcn components installed and importable
- form-builder-store has addFieldAtIndex action that inserts at specific index
- form-builder-store has duplicateField action that copies field with new ID
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/22-wysiwyg-form-builder/22-01-SUMMARY.md`
</output>

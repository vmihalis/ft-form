---
phase: 22-wysiwyg-form-builder
plan: 04
type: execute
wave: 3
depends_on: ["22-02", "22-03"]
files_modified:
  - src/components/form-builder/WysiwygCanvas.tsx
  - src/components/form-builder/FormBuilder.tsx
autonomous: true

must_haves:
  truths:
    - "Form builder shows form in actual rendered appearance (WYSIWYG)"
    - "Plus button between fields opens field type picker"
    - "Fields can be reordered via drag-and-drop"
    - "No separate preview mode - builder IS the preview"
    - "Clicking outside fields deselects current selection"
  artifacts:
    - path: "src/components/form-builder/WysiwygCanvas.tsx"
      provides: "WYSIWYG canvas integrating fields and add buttons"
      contains: "WysiwygField"
      min_lines: 60
    - path: "src/components/form-builder/FormBuilder.tsx"
      provides: "Updated form builder without preview toggle"
      contains: "WysiwygCanvas"
  key_links:
    - from: "src/components/form-builder/WysiwygCanvas.tsx"
      to: "src/components/form-builder/WysiwygField.tsx"
      via: "WysiwygField import"
      pattern: "WysiwygField"
    - from: "src/components/form-builder/WysiwygCanvas.tsx"
      to: "src/components/form-builder/AddFieldButton.tsx"
      via: "AddFieldButton import"
      pattern: "AddFieldButton"
    - from: "src/components/form-builder/FormBuilder.tsx"
      to: "src/components/form-builder/WysiwygCanvas.tsx"
      via: "WysiwygCanvas replaces FormCanvas"
      pattern: "WysiwygCanvas"
---

<objective>
Create WysiwygCanvas and update FormBuilder to complete WYSIWYG form builder transformation.

Purpose: Integrate WysiwygField and AddFieldButton into a cohesive canvas. Remove preview toggle from FormBuilder since builder IS the preview.

Output: Fully functional WYSIWYG form builder where forms display exactly as users will see them.
</objective>

<execution_context>
@/home/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/home/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-wysiwyg-form-builder/22-RESEARCH.md
@.planning/phases/22-wysiwyg-form-builder/22-01-SUMMARY.md
@.planning/phases/22-wysiwyg-form-builder/22-02-SUMMARY.md
@.planning/phases/22-wysiwyg-form-builder/22-03-SUMMARY.md

@src/components/form-builder/FormBuilder.tsx
@src/components/form-builder/FormCanvas.tsx
@src/lib/stores/form-builder-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WysiwygCanvas component</name>
  <files>src/components/form-builder/WysiwygCanvas.tsx</files>
  <action>
Create the main WYSIWYG canvas that integrates fields with add buttons:

```typescript
// src/components/form-builder/WysiwygCanvas.tsx
"use client";

import { useState } from "react";
import {
  DndContext,
  closestCenter,
  PointerSensor,
  KeyboardSensor,
  useSensor,
  useSensors,
  DragOverlay,
  type DragStartEvent,
  type DragEndEvent,
} from "@dnd-kit/core";
import {
  SortableContext,
  sortableKeyboardCoordinates,
  verticalListSortingStrategy,
} from "@dnd-kit/sortable";
import { FormProvider, useForm } from "react-hook-form";
import { WysiwygField } from "./WysiwygField";
import { AddFieldButton } from "./AddFieldButton";
import { DynamicField } from "@/components/dynamic-form/fields";
import { useFormBuilderStore } from "@/lib/stores/form-builder-store";
import type { FieldType } from "@/types/form-schema";

export function WysiwygCanvas() {
  const {
    schema,
    selectedStepIndex,
    reorderFields,
    addFieldAtIndex,
    selectField,
    getFieldById,
  } = useFormBuilderStore();

  const [activeId, setActiveId] = useState<string | null>(null);

  const currentStep = schema.steps[selectedStepIndex];
  const fields = currentStep?.fields ?? [];

  // Mock form context for DynamicField rendering
  const methods = useForm({ defaultValues: {}, mode: "onChange" });

  // Configure sensors with activation constraints
  const sensors = useSensors(
    useSensor(PointerSensor, {
      activationConstraint: {
        distance: 8, // Prevent accidental drags
      },
    }),
    useSensor(KeyboardSensor, {
      coordinateGetter: sortableKeyboardCoordinates,
    })
  );

  const handleAddField = (index: number) => (type: FieldType) => {
    addFieldAtIndex(selectedStepIndex, type, index);
  };

  const handleDragStart = (event: DragStartEvent) => {
    setActiveId(event.active.id as string);
  };

  const handleDragEnd = (event: DragEndEvent) => {
    const { active, over } = event;
    setActiveId(null);

    if (!over || active.id === over.id) return;

    const oldIndex = fields.findIndex((f) => f.id === active.id);
    const newIndex = fields.findIndex((f) => f.id === over.id);

    if (oldIndex !== -1 && newIndex !== -1) {
      reorderFields(selectedStepIndex, oldIndex, newIndex);
    }
  };

  // Click on canvas background deselects field
  const handleCanvasClick = () => {
    selectField(null);
  };

  const activeField = activeId ? getFieldById(activeId) : null;

  // Empty state
  if (fields.length === 0) {
    return (
      <div className="flex flex-col items-center justify-center py-16 rounded-lg border-2 border-dashed">
        <p className="text-center text-muted-foreground mb-4">
          Add your first field to get started
        </p>
        <AddFieldButton onAddField={handleAddField(0)} />
      </div>
    );
  }

  return (
    <FormProvider {...methods}>
      <DndContext
        sensors={sensors}
        collisionDetection={closestCenter}
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
      >
        <div
          className="space-y-1 py-4"
          onClick={handleCanvasClick}
        >
          {/* Add button at top */}
          <AddFieldButton onAddField={handleAddField(0)} />

          <SortableContext
            items={fields.map((f) => f.id)}
            strategy={verticalListSortingStrategy}
          >
            {fields.map((field, index) => (
              <div key={field.id}>
                <WysiwygField
                  field={field}
                  stepIndex={selectedStepIndex}
                />
                {/* Add button after each field */}
                <AddFieldButton onAddField={handleAddField(index + 1)} />
              </div>
            ))}
          </SortableContext>
        </div>

        {/* Drag overlay shows actual field appearance */}
        <DragOverlay>
          {activeField ? (
            <div className="rounded-lg border bg-card p-4 shadow-lg pointer-events-none opacity-90">
              <DynamicField field={activeField} />
            </div>
          ) : null}
        </DragOverlay>
      </DndContext>
    </FormProvider>
  );
}
```

Key implementation notes:
- FormProvider wraps canvas so DynamicField components can use useFormContext
- DndContext + SortableContext for drag-and-drop (same pattern as FormCanvas)
- AddFieldButton between every field for Notion-style insertion
- DragOverlay shows actual DynamicField (WYSIWYG even while dragging)
- Clicking canvas (not a field) deselects via handleCanvasClick
- Empty state has centered AddFieldButton for first field
  </action>
  <verify>
- `ls src/components/form-builder/WysiwygCanvas.tsx` - file exists
- `grep "WysiwygField" src/components/form-builder/WysiwygCanvas.tsx` - imports WysiwygField
- `grep "AddFieldButton" src/components/form-builder/WysiwygCanvas.tsx` - imports AddFieldButton
- `grep "FormProvider" src/components/form-builder/WysiwygCanvas.tsx` - wraps in FormProvider
- `grep "addFieldAtIndex" src/components/form-builder/WysiwygCanvas.tsx` - uses new store action
- `npx tsc --noEmit` - no TypeScript errors
  </verify>
  <done>
WysiwygCanvas integrates WysiwygField components with AddFieldButton between them, FormProvider context, and drag-and-drop support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update FormBuilder to use WYSIWYG canvas</name>
  <files>src/components/form-builder/FormBuilder.tsx</files>
  <action>
Update FormBuilder to replace FormCanvas with WysiwygCanvas and remove preview toggle:

Changes to make:
1. Remove `useState` for previewMode
2. Remove `Eye`, `PenSquare` icons from imports
3. Remove preview toggle button from header
4. Replace `FormCanvas` import with `WysiwygCanvas`
5. Remove `PreviewPanel` import and conditional rendering
6. Always render WysiwygCanvas (not conditionally based on previewMode)
7. Keep FieldPalette visible (still useful for reference, though plus buttons are primary add method)

Updated structure:
```typescript
// src/components/form-builder/FormBuilder.tsx
"use client";

import Link from "next/link";
import { useFormBuilderStore } from "@/lib/stores/form-builder-store";
import { Button } from "@/components/ui/button";
import { ArrowLeft } from "lucide-react";
import { StepTabs } from "./StepTabs";
import { FormMetadataForm } from "./FormMetadataForm";
import { FieldPalette } from "./FieldPalette";
import { WysiwygCanvas } from "./WysiwygCanvas";
import { PropertyPanel } from "./PropertyPanel";
import { FormStatusActions } from "./FormStatusActions";

interface FormBuilderProps {
  formId: string;
  formName: string;
  formStatus: "draft" | "published" | "archived";
}

/**
 * FormBuilder - WYSIWYG Form Builder
 *
 * Three-panel layout:
 * - Left: Field palette (reference for field types)
 * - Center: Step tabs + WYSIWYG canvas (forms render as users see them)
 * - Right: Property panel (when field selected) or form metadata editor
 *
 * No preview mode needed - builder IS the preview (WYSIWYG).
 */
export function FormBuilder({ formId, formName }: FormBuilderProps) {
  const { selectedFieldId } = useFormBuilderStore();

  return (
    <div className="h-screen flex flex-col">
      {/* Header */}
      <header className="border-b px-6 py-3 flex items-center justify-between bg-background">
        <div className="flex items-center gap-4">
          <Link
            href="/admin/forms"
            className="text-muted-foreground hover:text-foreground"
          >
            <ArrowLeft className="h-5 w-5" />
          </Link>
          <h1 className="text-lg font-semibold">{formName}</h1>
        </div>
        <div className="flex items-center gap-2">
          {/* Status actions (badge, save, publish, archive) */}
          <FormStatusActions formId={formId} />
        </div>
      </header>

      {/* Three-panel layout */}
      <div className="flex flex-1 overflow-hidden">
        {/* Left: Field Palette */}
        <aside className="w-64 border-r p-4 bg-muted/30 overflow-y-auto">
          <FieldPalette />
        </aside>

        {/* Center: Step Tabs + WYSIWYG Canvas */}
        <main className="flex-1 p-6 bg-background overflow-y-auto">
          <StepTabs />
          <div className="mt-6">
            <WysiwygCanvas />
          </div>
        </main>

        {/* Right: Property Panel or Form Metadata */}
        <aside className="w-80 border-l p-4 bg-muted/30 overflow-y-auto">
          {selectedFieldId ? (
            <PropertyPanel fieldId={selectedFieldId} />
          ) : (
            <FormMetadataForm formId={formId} />
          )}
        </aside>
      </div>
    </div>
  );
}
```

Key changes:
- Removed previewMode state and toggle button (BUILD-09: no separate preview mode)
- Replaced FormCanvas with WysiwygCanvas
- Removed PreviewPanel (no longer needed)
- Updated component doc comment to reflect WYSIWYG approach
- FieldPalette kept as reference (users can still see available types)
  </action>
  <verify>
- `grep "WysiwygCanvas" src/components/form-builder/FormBuilder.tsx` - uses WysiwygCanvas
- `grep -v "previewMode" src/components/form-builder/FormBuilder.tsx | wc -l` equals total lines (no previewMode)
- `grep -v "PreviewPanel" src/components/form-builder/FormBuilder.tsx | wc -l` equals total lines (no PreviewPanel)
- `grep -v "Eye\|PenSquare" src/components/form-builder/FormBuilder.tsx | wc -l` equals total lines (icons removed)
- `npx tsc --noEmit` - no TypeScript errors
  </verify>
  <done>
FormBuilder updated to use WysiwygCanvas, preview toggle removed, three-panel WYSIWYG layout active.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete WYSIWYG form builder with:
- Fields render as actual form inputs (not metadata cards)
- Floating toolbar appears when field is selected (edit/delete/duplicate)
- Plus buttons between fields for adding new fields
- Field type picker popover with all 10 types
- Drag-and-drop reordering works
- No separate preview mode - builder IS the preview
  </what-built>
  <how-to-verify>
1. Start dev server if not running: `npm run dev`
2. Navigate to http://localhost:3000/admin/forms
3. Click on an existing form (or create a new one)
4. Verify WYSIWYG rendering:
   - Fields should look like actual form inputs (not cards with icons)
   - Text fields show input with placeholder, dropdown shows select, etc.
5. Test field selection:
   - Click a field - should show ring highlight
   - Floating toolbar should appear above field with edit/delete/duplicate icons
6. Test toolbar actions:
   - Click duplicate icon - should create copy of field below
   - Click delete icon - should remove field
7. Test add field:
   - Hover between two fields - plus button and line should appear
   - Click plus button - field type picker popover should open
   - Click a type - new field should be inserted at that position
8. Test drag-and-drop:
   - Hover over field left edge - drag handle should appear
   - Drag a field to new position - should reorder
9. Test deselection:
   - Click empty area of canvas - field should deselect, toolbar disappear
10. Verify no preview toggle:
    - Header should NOT have Preview/Edit toggle button
  </how-to-verify>
  <resume-signal>Type "approved" if WYSIWYG builder works correctly, or describe any issues found.</resume-signal>
</task>

</tasks>

<verification>
1. `ls src/components/form-builder/WysiwygCanvas.tsx` - file exists
2. `grep "WysiwygCanvas" src/components/form-builder/FormBuilder.tsx` - FormBuilder uses WysiwygCanvas
3. `npx tsc --noEmit` - no TypeScript errors
4. Manual verification: Form builder displays fields as actual inputs (WYSIWYG)
5. Manual verification: Floating toolbar appears on field selection
6. Manual verification: Plus buttons work between fields
7. Manual verification: No preview toggle in header
</verification>

<success_criteria>
- Form builder shows form in actual rendered appearance (BUILD-01)
- Clicking field reveals floating toolbar with edit/delete/duplicate (BUILD-02)
- Plus button between fields opens field type picker (BUILD-03, BUILD-04)
- Field properties edited via PropertyPanel (BUILD-05)
- Fields can be reordered via drag-and-drop (BUILD-06)
- All 10 field types supported (BUILD-07)
- Real-time validation in PropertyPanel (BUILD-08 - existing)
- No separate preview mode - builder IS preview (BUILD-09)
</success_criteria>

<output>
After completion, create `.planning/phases/22-wysiwyg-form-builder/22-04-SUMMARY.md`
</output>

---
phase: 28-integration-polish
plan: 02
type: execute
wave: 2
depends_on: ["28-01"]
files_modified:
  - src/components/ui/dialog.tsx
  - src/components/ai-wizard/CreateFormModal.tsx
  - src/app/admin/forms/new/ai/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can enter form name and slug after accepting AI schema"
    - "Slug shows real-time availability feedback (available/taken)"
    - "Created form is saved as draft"
    - "After creation, user can choose to edit in builder or view forms list"
  artifacts:
    - path: "src/components/ui/dialog.tsx"
      provides: "Dialog modal component"
      exports: ["Dialog", "DialogContent", "DialogHeader", "DialogTitle", "DialogDescription", "DialogFooter"]
    - path: "src/components/ai-wizard/CreateFormModal.tsx"
      provides: "Form creation modal with name/slug inputs"
      exports: ["CreateFormModal"]
    - path: "src/app/admin/forms/new/ai/page.tsx"
      provides: "AI wizard page with creation flow"
      contains: "CreateFormModal"
  key_links:
    - from: "src/components/ai-wizard/CreateFormModal.tsx"
      to: "api.forms.isSlugAvailable"
      via: "useQuery for real-time validation"
      pattern: "useQuery.*isSlugAvailable"
    - from: "src/components/ai-wizard/CreateFormModal.tsx"
      to: "api.forms.createWithSchema"
      via: "useMutation for form creation"
      pattern: "useMutation.*createWithSchema"
    - from: "src/app/admin/forms/new/ai/page.tsx"
      to: "CreateFormModal"
      via: "component import and render"
      pattern: "CreateFormModal"
---

<objective>
Create the form creation modal and integrate it into the AI wizard flow.

Purpose: Enable users to name and save AI-generated forms as drafts, with real-time slug validation and post-creation navigation choices.
Output: Dialog UI component, CreateFormModal component, updated AI page with full creation flow.
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-integration-polish/28-RESEARCH.md
@.planning/phases/28-integration-polish/28-01-SUMMARY.md

@src/app/admin/forms/new/ai/page.tsx
@src/components/ui/alert-dialog.tsx
@src/components/ui/sheet.tsx
@src/lib/ai/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dialog UI component</name>
  <files>src/components/ui/dialog.tsx</files>
  <action>
Create a Dialog component following shadcn/ui patterns, similar to the existing AlertDialog but for general modals.

Use @radix-ui/react-dialog (already installed - Sheet uses it as SheetPrimitive).

Exports needed:
- Dialog (Root)
- DialogTrigger
- DialogPortal
- DialogOverlay
- DialogContent
- DialogHeader
- DialogFooter
- DialogTitle
- DialogDescription
- DialogClose

Follow the styling patterns from alert-dialog.tsx:
- Overlay: "data-[state=open]:animate-in data-[state=closed]:animate-out ... fixed inset-0 z-50 bg-black/50"
- Content: "glass-card ... fixed top-[50%] left-[50%] ... translate-x-[-50%] translate-y-[-50%]"
- Use sm:max-w-md for content (appropriate for form input modal)

DialogHeader should use flex flex-col gap-1.5, DialogFooter should use flex flex-col-reverse sm:flex-row sm:justify-end gap-2.

Mark as 'use client'.
  </action>
  <verify>
File exists at `src/components/ui/dialog.tsx`.
No TypeScript errors: `npx tsc --noEmit`.
  </verify>
  <done>
Dialog component exports all required pieces following shadcn patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CreateFormModal component</name>
  <files>src/components/ai-wizard/CreateFormModal.tsx</files>
  <action>
Create the modal that collects form name and slug after user accepts an AI-generated schema.

Props interface:
```tsx
interface CreateFormModalProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  schema: AIFormSchemaOutput;
}
```

Implementation requirements:

1. **State:**
   - name: string (form name input)
   - slugInput: string (raw slug input)
   - isSubmitting: boolean
   - error: string | null
   - createdFormId: Id<"forms"> | null (for success state)

2. **Slug normalization:**
   - Create `normalizeSlug` function: lowercase, replace non-alphanumeric with hyphen, collapse consecutive hyphens, trim leading/trailing hyphens
   - Apply to slugInput to get normalized `slug`

3. **Debounced availability check:**
   - Import useDebounce from 'use-debounce'
   - Debounce the normalized slug (300ms)
   - useQuery for api.forms.isSlugAvailable with debouncedSlug
   - Skip query if slug.length < 2

4. **Validation UI:**
   - Show error if slug < 2 chars after user starts typing
   - Show "This slug is already in use" if slugAvailable === false
   - Show "Available!" in green if slugAvailable === true and slug >= 2

5. **Form submission:**
   - Call api.forms.createWithSchema with { name, slug, draftSchema: JSON.stringify(schema) }
   - On success, set createdFormId (do NOT close modal yet - show success state)
   - On error, display error message

6. **Success state (when createdFormId is set):**
   - Show green checkmark icon
   - "Form Created!" title
   - "Your form has been saved as a draft." description
   - Two buttons:
     - "View All Forms" (outline) -> Link to /admin/forms
     - "Edit in Builder" (primary) -> Link to /admin/forms/${createdFormId}

7. **Initial state (form input):**
   - "Create Your Form" title
   - "Give your AI-generated form a name and URL." description
   - Form Name input (autoFocus)
   - URL Slug input with /apply/ prefix (styled like existing /admin/forms/new page)
   - Cancel and Create Form buttons

8. **Mobile responsiveness:**
   - DialogFooter with flex-col-reverse gap-2 sm:flex-row
   - Buttons full-width on mobile: w-full sm:w-auto
   - Touch-friendly targets (default Button height is fine)

Use Dialog from @/components/ui/dialog.
Use Field, FieldLabel, FieldDescription, FieldError from @/components/ui/field.
Use CheckCircle from lucide-react for success icon.
  </action>
  <verify>
File exists at `src/components/ai-wizard/CreateFormModal.tsx`.
No TypeScript errors: `npx tsc --noEmit`.
  </verify>
  <done>
CreateFormModal:
- Collects name and slug with validation
- Shows real-time slug availability
- Creates form as draft via createWithSchema
- Shows success state with navigation options
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate CreateFormModal into AI wizard page</name>
  <files>src/app/admin/forms/new/ai/page.tsx</files>
  <action>
Replace the placeholder success state with the CreateFormModal flow.

Changes to make:

1. **Add state for modal:**
   ```tsx
   const [showCreateModal, setShowCreateModal] = useState(false);
   ```

2. **Update handleComplete:**
   Instead of setting completedSchema and showing the placeholder success card:
   ```tsx
   const handleComplete = (schema: AIFormSchemaOutput) => {
     setCompletedSchema(schema);
     setShowCreateModal(true);
   };
   ```

3. **Remove the placeholder success state section:**
   Delete the entire `if (completedSchema)` block that shows the temporary success card with "Form creation will be available in the next update."

4. **Add CreateFormModal to the render:**
   After the main content (but still inside the page), add:
   ```tsx
   {completedSchema && (
     <CreateFormModal
       open={showCreateModal}
       onOpenChange={(open) => {
         setShowCreateModal(open);
         if (!open) {
           // User closed modal without completing - return to wizard
           // They can click "Use This Form" again
         }
       }}
       schema={completedSchema}
     />
   )}
   ```

5. **Import CreateFormModal:**
   ```tsx
   import { CreateFormModal } from '@/components/ai-wizard/CreateFormModal';
   ```

The flow is now:
1. User completes AI wizard and clicks "Use This Form"
2. AIFormWizard calls onComplete with schema
3. Page stores schema and opens CreateFormModal
4. User enters name/slug in modal
5. Modal creates form and shows success state
6. User navigates to builder or forms list

If user closes modal without completing, the schema is still stored and they can re-open by clicking "Use This Form" again in the preview.
  </action>
  <verify>
Run `pnpm dev`, navigate to /admin/forms/new/ai.
Complete the AI wizard flow through to preview.
Click "Use This Form" - CreateFormModal should appear.
Enter name and slug - should show availability feedback.
Click Create Form - should show success state with navigation options.
  </verify>
  <done>
AI wizard flow complete:
- CRT-01: User provides form name and slug before creation
- CRT-02: Slug validated for uniqueness (debounced query)
- CRT-03: Form saved as draft (createWithSchema mutation)
- CRT-04: Post-creation navigation choice (Edit in Builder / View All Forms)
  </done>
</task>

</tasks>

<verification>
1. TypeScript: `npx tsc --noEmit` passes
2. Full flow test:
   - Go to /admin/forms
   - Click New Form -> Create with AI
   - Complete wizard (select form type, audience, describe form)
   - Wait for AI to generate schema
   - Click "Use This Form" in preview
   - Modal opens with name/slug inputs
   - Enter name, enter slug (see availability feedback)
   - Click Create Form
   - See success state
   - Click "Edit in Builder" -> navigates to form builder
   - Verify form appears in forms list as draft
3. Mobile: Test at 375px width - buttons should stack, modal should fit screen
</verification>

<success_criteria>
- Dialog component exists and works correctly
- CreateFormModal collects name/slug with real-time validation
- Form creation saves as draft (verify status in form builder)
- Success state shows navigation choices
- Both navigation options work correctly
- Mobile responsive (no horizontal scroll, buttons accessible)
</success_criteria>

<output>
After completion, create `.planning/phases/28-integration-polish/28-02-SUMMARY.md`
</output>

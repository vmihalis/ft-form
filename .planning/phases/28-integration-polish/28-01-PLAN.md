---
phase: 28-integration-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/forms.ts
  - src/components/form-builder/NewFormDropdown.tsx
  - src/app/admin/forms/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees 'Create with AI' option in New Form dropdown"
    - "User sees 'Create Manually' option in New Form dropdown"
    - "Slug availability can be checked before form creation"
    - "Forms can be created with pre-populated schema"
  artifacts:
    - path: "convex/forms.ts"
      provides: "isSlugAvailable query and createWithSchema mutation"
      exports: ["isSlugAvailable", "createWithSchema"]
    - path: "src/components/form-builder/NewFormDropdown.tsx"
      provides: "Dropdown with Manual and AI creation options"
      exports: ["NewFormDropdown"]
    - path: "src/app/admin/forms/page.tsx"
      provides: "Forms list with dropdown entry point"
      contains: "NewFormDropdown"
  key_links:
    - from: "src/app/admin/forms/page.tsx"
      to: "NewFormDropdown"
      via: "component import"
      pattern: "NewFormDropdown"
    - from: "NewFormDropdown"
      to: "/admin/forms/new"
      via: "Link href"
      pattern: "href=.*forms/new"
    - from: "NewFormDropdown"
      to: "/admin/forms/new/ai"
      via: "Link href"
      pattern: "href=.*forms/new/ai"
---

<objective>
Add backend support for AI form creation and the "New Form" dropdown entry point.

Purpose: Enable slug validation before form creation and provide discoverable entry point for AI form creation alongside manual creation.
Output: Backend queries/mutations for form creation flow, NewFormDropdown component, updated forms list page.
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-integration-polish/28-RESEARCH.md

@convex/forms.ts
@src/app/admin/forms/page.tsx
@src/components/form-builder/FormQuickActions.tsx
@src/components/ui/dropdown-menu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add isSlugAvailable query and createWithSchema mutation</name>
  <files>convex/forms.ts</files>
  <action>
Add two new exports to convex/forms.ts:

1. `isSlugAvailable` query:
   - Args: `{ slug: v.string() }`
   - Normalize the slug using existing `normalizeSlug` function
   - Return `false` if slug is in `RESERVED_SLUGS`
   - Query forms by_slug index, return `true` if no match found, `false` if exists
   - This enables real-time slug validation in the UI before form creation

2. `createWithSchema` mutation:
   - Args: `{ name: v.string(), slug: v.string(), draftSchema: v.string(), description: v.optional(v.string()) }`
   - Follow same validation pattern as existing `create` mutation:
     - Normalize slug
     - Check empty slug
     - Check reserved slugs
     - Check uniqueness
   - Additionally validate that draftSchema is valid JSON (try/catch JSON.parse)
   - Insert form with status: "draft" (never auto-publish AI forms per CRT-03)
   - Return the form ID

Keep the existing `create` mutation unchanged - it's still used by manual form creation.
  </action>
  <verify>
Run `npx convex dev` - should deploy without errors.
Run `npx convex functions list` - should show `forms:isSlugAvailable` and `forms:createWithSchema`.
  </verify>
  <done>
`isSlugAvailable` query returns true for available slugs, false for taken/reserved.
`createWithSchema` mutation creates draft form with provided schema.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create NewFormDropdown component</name>
  <files>src/components/form-builder/NewFormDropdown.tsx</files>
  <action>
Create a new client component that replaces the simple "New Form" button with a dropdown menu.

Structure:
```tsx
'use client';

import Link from 'next/link';
import { Plus, Sparkles, FileText } from 'lucide-react';
import { Button } from '@/components/ui/button';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
```

Implementation:
- DropdownMenuTrigger wraps a Button with Plus icon and "New Form" text
- DropdownMenuContent aligned "end" with width "w-48"
- Two DropdownMenuItem entries, each wrapping a Next.js Link:
  1. FileText icon + "Create Manually" -> href="/admin/forms/new"
  2. Sparkles icon + "Create with AI" -> href="/admin/forms/new/ai"

Follow the pattern from FormQuickActions.tsx for DropdownMenuItem with asChild and Link.
Icons should have className "h-4 w-4 mr-2".
  </action>
  <verify>
File exists at `src/components/form-builder/NewFormDropdown.tsx`.
No TypeScript errors: `npx tsc --noEmit`.
  </verify>
  <done>
NewFormDropdown component exports and renders dropdown with Manual and AI options.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update forms list page to use NewFormDropdown</name>
  <files>src/app/admin/forms/page.tsx</files>
  <action>
Modify the forms list page to use the new dropdown instead of a simple Link button.

Changes:
1. Remove the direct Link import usage for the New Form button
2. Import NewFormDropdown from '@/components/form-builder/NewFormDropdown'
3. Replace the existing Link/Button combo in the header:
   ```tsx
   // Before:
   <Link href="/admin/forms/new">
     <Button>
       <Plus className="h-4 w-4 mr-2" />
       New Form
     </Button>
   </Link>

   // After:
   <NewFormDropdown />
   ```

The page remains a server component - NewFormDropdown handles its own client-side interactivity.
Keep all other code unchanged (auth check, metadata, FormsList, etc.).
  </action>
  <verify>
Run `pnpm dev`, visit http://localhost:3000/admin/forms.
Click "New Form" button - dropdown appears with two options.
Click "Create Manually" - navigates to /admin/forms/new.
Click "Create with AI" - navigates to /admin/forms/new/ai.
  </verify>
  <done>
Forms list page shows NewFormDropdown with both creation paths discoverable.
Requirement UX-01 satisfied: "Create with AI" option appears in New Form dropdown.
  </done>
</task>

</tasks>

<verification>
1. Backend: `npx convex dev` runs without errors
2. TypeScript: `npx tsc --noEmit` passes
3. UI: Dropdown renders on /admin/forms with both options
4. Navigation: Both dropdown links navigate to correct pages
</verification>

<success_criteria>
- `forms:isSlugAvailable` query deployed and callable
- `forms:createWithSchema` mutation deployed and callable
- NewFormDropdown component exists and exports correctly
- /admin/forms shows dropdown instead of simple button
- Both "Create Manually" and "Create with AI" links work
</success_criteria>

<output>
After completion, create `.planning/phases/28-integration-polish/28-01-SUMMARY.md`
</output>

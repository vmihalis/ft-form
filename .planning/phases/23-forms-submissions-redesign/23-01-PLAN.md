---
phase: 23-forms-submissions-redesign
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/forms.ts
  - src/components/form-builder/FormCard.tsx
  - src/components/form-builder/FormQuickActions.tsx
autonomous: true

must_haves:
  truths:
    - "Forms list displays with glassmorphism card styling"
    - "Each form card shows status badge, submission count, and last updated date"
    - "Quick actions (edit, duplicate, archive) available via dropdown menu"
  artifacts:
    - path: "convex/forms.ts"
      provides: "forms.list query with submissionCount"
      contains: "submissionCount"
    - path: "src/components/form-builder/FormCard.tsx"
      provides: "Glass-styled form card component"
      contains: "glass-card"
    - path: "src/components/form-builder/FormQuickActions.tsx"
      provides: "Quick actions dropdown component"
      contains: "DropdownMenu"
  key_links:
    - from: "src/components/form-builder/FormCard.tsx"
      to: "FormQuickActions.tsx"
      via: "Rendered inside card header"
      pattern: "FormQuickActions"
---

<objective>
Create glassmorphism form card component with submission count from backend and quick actions dropdown.

Purpose: Transform the forms list from a plain table to premium glass-styled cards with all required metadata (FORM-01, FORM-02, FORM-03).

Output: FormCard component with glass styling, FormQuickActions dropdown, and updated forms.list query including submission counts.
</objective>

<execution_context>
@/home/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/home/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-forms-submissions-redesign/23-RESEARCH.md

# Key files for understanding existing patterns
@src/components/admin/ModuleCard.tsx
@src/components/form-builder/FormsList.tsx
@convex/forms.ts
@src/app/globals.css
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add submissionCount to forms.list query</name>
  <files>convex/forms.ts</files>
  <action>
Modify the `list` query in convex/forms.ts to include submission count for each form.

Add a count query for each form's submissions. Use the existing submissions table and aggregate:

```typescript
export const list = query({
  handler: async (ctx) => {
    const forms = await ctx.db
      .query("forms")
      .order("desc")
      .collect();

    // Get submission counts for all forms
    const formsWithCounts = await Promise.all(
      forms.map(async (form) => {
        const submissions = await ctx.db
          .query("submissions")
          .withIndex("by_form", (q) => q.eq("formId", form._id))
          .collect();

        return {
          _id: form._id,
          name: form.name,
          slug: form.slug,
          description: form.description,
          status: form.status,
          currentVersionId: form.currentVersionId,
          createdAt: form.createdAt,
          updatedAt: form.updatedAt,
          submissionCount: submissions.length,
        };
      })
    );

    return formsWithCounts;
  },
});
```

Important: Check if submissions table has a by_form index. If not, use `.filter()` instead:
```typescript
const submissions = await ctx.db
  .query("submissions")
  .filter((q) => q.eq(q.field("formId"), form._id))
  .collect();
```
  </action>
  <verify>Run `npx convex dev` - should deploy without errors. Check terminal for successful deployment.</verify>
  <done>forms.list query returns submissionCount field for each form</done>
</task>

<task type="auto">
  <name>Task 2: Create FormQuickActions dropdown component</name>
  <files>src/components/form-builder/FormQuickActions.tsx</files>
  <action>
Create a new component for quick actions dropdown that can be used on form cards.

Create `src/components/form-builder/FormQuickActions.tsx`:

```typescript
"use client";

import { useState } from "react";
import Link from "next/link";
import { useMutation } from "convex/react";
import { api } from "@/../convex/_generated/api";
import { Id } from "@/../convex/_generated/dataModel";
import { MoreHorizontal, Pencil, Copy, Archive, ExternalLink, RotateCcw } from "lucide-react";
import { Button } from "@/components/ui/button";
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuSeparator,
  DropdownMenuTrigger,
} from "@/components/ui/dropdown-menu";

interface FormQuickActionsProps {
  formId: Id<"forms">;
  slug: string;
  status: "draft" | "published" | "archived";
  onDuplicate?: () => void;
}

export function FormQuickActions({
  formId,
  slug,
  status,
  onDuplicate,
}: FormQuickActionsProps) {
  const publish = useMutation(api.forms.publish);
  const unpublish = useMutation(api.forms.unpublish);
  const archive = useMutation(api.forms.archive);
  const unarchive = useMutation(api.forms.unarchive);

  const [isLoading, setIsLoading] = useState(false);

  const handleStatusAction = async (action: () => Promise<void>) => {
    setIsLoading(true);
    try {
      await action();
    } catch (error) {
      console.error("Action failed:", error);
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <DropdownMenu>
      <DropdownMenuTrigger asChild>
        <Button
          variant="ghost"
          size="icon"
          className="h-8 w-8"
          onClick={(e) => e.stopPropagation()}
          disabled={isLoading}
        >
          <MoreHorizontal className="h-4 w-4" />
          <span className="sr-only">Open menu</span>
        </Button>
      </DropdownMenuTrigger>
      <DropdownMenuContent align="end" className="w-48">
        <DropdownMenuItem asChild>
          <Link href={`/admin/forms/${formId}`}>
            <Pencil className="h-4 w-4 mr-2" />
            Edit
          </Link>
        </DropdownMenuItem>

        {onDuplicate && (
          <DropdownMenuItem onClick={(e) => { e.stopPropagation(); onDuplicate(); }}>
            <Copy className="h-4 w-4 mr-2" />
            Duplicate
          </DropdownMenuItem>
        )}

        <DropdownMenuSeparator />

        {status === "draft" && (
          <DropdownMenuItem
            onClick={(e) => {
              e.stopPropagation();
              handleStatusAction(() => publish({ formId }));
            }}
          >
            <ExternalLink className="h-4 w-4 mr-2" />
            Publish
          </DropdownMenuItem>
        )}

        {status === "published" && (
          <>
            <DropdownMenuItem asChild>
              <Link href={`/apply/${slug}`} target="_blank" onClick={(e) => e.stopPropagation()}>
                <ExternalLink className="h-4 w-4 mr-2" />
                View Live
              </Link>
            </DropdownMenuItem>
            <DropdownMenuItem
              onClick={(e) => {
                e.stopPropagation();
                handleStatusAction(() => unpublish({ formId }));
              }}
            >
              <Archive className="h-4 w-4 mr-2" />
              Unpublish
            </DropdownMenuItem>
          </>
        )}

        {status !== "archived" && (
          <DropdownMenuItem
            onClick={(e) => {
              e.stopPropagation();
              handleStatusAction(() => archive({ formId }));
            }}
            className="text-destructive focus:text-destructive"
          >
            <Archive className="h-4 w-4 mr-2" />
            Archive
          </DropdownMenuItem>
        )}

        {status === "archived" && (
          <DropdownMenuItem
            onClick={(e) => {
              e.stopPropagation();
              handleStatusAction(() => unarchive({ formId }));
            }}
          >
            <RotateCcw className="h-4 w-4 mr-2" />
            Restore
          </DropdownMenuItem>
        )}
      </DropdownMenuContent>
    </DropdownMenu>
  );
}
```

Note: Check if `archive` and `unarchive` mutations exist in forms.ts. If not, the archive action should toggle status to "archived" and restore toggles back to "draft". May need to create these mutations or adjust to use existing status update logic.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>FormQuickActions component exists with edit, duplicate, publish/unpublish, and archive actions</done>
</task>

<task type="auto">
  <name>Task 3: Create FormCard glass component</name>
  <files>src/components/form-builder/FormCard.tsx</files>
  <action>
Create the FormCard component with glassmorphism styling following the ModuleCard pattern.

Create `src/components/form-builder/FormCard.tsx`:

```typescript
"use client";

import Link from "next/link";
import { motion } from "motion/react";
import { Badge } from "@/components/ui/badge";
import { FormQuickActions } from "./FormQuickActions";
import { Id } from "@/../convex/_generated/dataModel";

const statusConfig = {
  draft: {
    label: "Draft",
    className: "bg-yellow-100/80 text-yellow-800 border-yellow-300 dark:bg-yellow-900/30 dark:text-yellow-400 dark:border-yellow-800",
  },
  published: {
    label: "Published",
    className: "bg-green-100/80 text-green-800 border-green-300 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800",
  },
  archived: {
    label: "Archived",
    className: "bg-muted text-muted-foreground border-border",
  },
} as const;

interface FormCardProps {
  form: {
    _id: Id<"forms">;
    name: string;
    slug: string;
    status: "draft" | "published" | "archived";
    submissionCount: number;
    updatedAt: number;
  };
  onDuplicate: () => void;
}

export function FormCard({ form, onDuplicate }: FormCardProps) {
  const status = statusConfig[form.status];
  const lastUpdated = new Date(form.updatedAt).toLocaleDateString("en-US", {
    month: "short",
    day: "numeric",
  });

  return (
    <motion.div
      className="glass-card rounded-2xl p-6 min-h-[180px] flex flex-col"
      whileHover={{
        scale: 1.02,
        boxShadow: "0 30px 60px -12px oklch(0 0 0 / 20%)",
      }}
      whileTap={{ scale: 0.98 }}
      transition={{ duration: 0.2 }}
    >
      {/* Header with status and actions */}
      <div className="flex items-start justify-between mb-4">
        <Badge variant="outline" className={status.className}>
          {status.label}
        </Badge>
        <FormQuickActions
          formId={form._id}
          slug={form.slug}
          status={form.status}
          onDuplicate={onDuplicate}
        />
      </div>

      {/* Main content - clickable area */}
      <Link href={`/admin/forms/${form._id}`} className="flex-1 block">
        <h3 className="font-display text-lg font-semibold text-foreground truncate mb-2">
          {form.name}
        </h3>
        <p className="text-sm text-muted-foreground truncate">/apply/{form.slug}</p>
      </Link>

      {/* Footer stats */}
      <div className="flex items-center justify-between mt-4 pt-4 border-t border-glass-border text-sm text-muted-foreground">
        <span>
          {form.submissionCount} {form.submissionCount === 1 ? "submission" : "submissions"}
        </span>
        <span>Updated {lastUpdated}</span>
      </div>
    </motion.div>
  );
}
```

Note: The `border-glass-border` class should use the CSS variable. If Tailwind doesn't recognize it, use inline style:
```typescript
style={{ borderColor: 'var(--glass-border)' }}
```
Or use `border-border` which is a theme-aware alternative.
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>FormCard component renders with glass-card styling, status badge, submission count, and last updated date</done>
</task>

</tasks>

<verification>
1. `npx convex dev` deploys successfully with updated forms.list query
2. `npx tsc --noEmit` passes with no type errors
3. FormCard.tsx uses glass-card class for glassmorphism styling
4. FormQuickActions.tsx has all quick actions (edit, duplicate, archive)
</verification>

<success_criteria>
- forms.list returns submissionCount for each form (FORM-02 partial)
- FormCard component displays with glassmorphism styling (FORM-01)
- FormCard shows status, submission count, last updated (FORM-02)
- Quick actions dropdown available on each card (FORM-03)
</success_criteria>

<output>
After completion, create `.planning/phases/23-forms-submissions-redesign/23-01-SUMMARY.md`
</output>

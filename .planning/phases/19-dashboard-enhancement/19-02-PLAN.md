---
phase: 19-dashboard-enhancement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/submissions.ts
  - src/components/admin/ActivityFeed.tsx
  - src/components/admin/AdminTabs.tsx
autonomous: true

must_haves:
  truths:
    - "Admin sees recent submissions in activity feed"
    - "Activity feed shows submission name, form, and timestamp"
    - "Activity feed updates in real-time when new submissions arrive"
  artifacts:
    - path: "convex/submissions.ts"
      provides: "getRecentActivity query"
      exports: ["getRecentActivity"]
    - path: "src/components/admin/ActivityFeed.tsx"
      provides: "Activity feed list component"
      min_lines: 50
    - path: "src/components/admin/AdminTabs.tsx"
      provides: "Dashboard tab with activity feed"
      contains: "ActivityFeed"
  key_links:
    - from: "src/components/admin/ActivityFeed.tsx"
      to: "api.submissions.getRecentActivity"
      via: "useQuery hook"
      pattern: "useQuery.*api\\.submissions\\.getRecentActivity"
    - from: "src/components/admin/AdminTabs.tsx"
      to: "ActivityFeed"
      via: "component import and render in dashboard tab"
      pattern: "import.*ActivityFeed"
---

<objective>
Add activity feed showing recent submissions to the admin dashboard.

Purpose: Gives admins a quick view of what's happening without opening the full submissions table.
Output: ActivityFeed component showing last 10 submissions with form name and relative timestamp, rendered in a new "Dashboard" tab.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-dashboard-enhancement/19-RESEARCH.md

@convex/submissions.ts
@convex/schema.ts
@src/components/admin/AdminTabs.tsx
@src/components/ui/card.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create getRecentActivity query in Convex</name>
  <files>convex/submissions.ts</files>
  <action>
Add a `getRecentActivity` query that returns recent submissions with enriched data.

Implementation:
1. Add new query export `getRecentActivity` with optional `limit` arg (default 10)
2. Query submissions ordered by `submittedAt` descending using `by_submitted` index
3. Take first N submissions (limit)
4. Enrich each with form name by joining through formVersionId -> formVersion -> form
5. Parse submission data to extract a display name (first text field with "name" in id, or first text value)

Return type:
```typescript
Array<{
  _id: Id<"submissions">;
  formName: string;
  submitterName: string; // Extracted from data or "Anonymous"
  status: string;
  submittedAt: number;
}>
```

```typescript
export const getRecentActivity = query({
  args: { limit: v.optional(v.number()) },
  handler: async (ctx, args) => {
    const limit = args.limit ?? 10;

    const submissions = await ctx.db
      .query("submissions")
      .withIndex("by_submitted")
      .order("desc")
      .take(limit);

    const enriched = await Promise.all(
      submissions.map(async (sub) => {
        const version = await ctx.db.get(sub.formVersionId);
        const form = version ? await ctx.db.get(version.formId) : null;

        // Extract submitter name from data
        const data = JSON.parse(sub.data) as Record<string, unknown>;
        let submitterName = "Anonymous";

        // Look for common name fields
        for (const [key, value] of Object.entries(data)) {
          if (typeof value === "string" && value.trim()) {
            if (key.toLowerCase().includes("name") && !key.toLowerCase().includes("email")) {
              submitterName = value;
              break;
            }
          }
        }

        return {
          _id: sub._id,
          formName: form?.name ?? "Unknown Form",
          submitterName,
          status: sub.status,
          submittedAt: sub.submittedAt,
        };
      })
    );

    return enriched;
  },
});
```
  </action>
  <verify>Run `npx convex dev` - no type errors. Query appears in Convex functions.</verify>
  <done>getRecentActivity query returns enriched recent submissions.</done>
</task>

<task type="auto">
  <name>Task 2: Create ActivityFeed component</name>
  <files>src/components/admin/ActivityFeed.tsx</files>
  <action>
Create a component that displays recent submissions in a list format.

Implementation:
1. Create `ActivityFeed.tsx` in `src/components/admin/`
2. Use `useQuery(api.submissions.getRecentActivity)` to fetch data
3. Display in a Card with title "Recent Activity"
4. List items with:
   - Submitter name (bold)
   - "submitted to {formName}" text
   - Relative time (e.g., "5 minutes ago") using Intl.RelativeTimeFormat or simple calculation
   - Small status badge on right
5. Show loading skeleton while loading
6. Show "No recent activity" if empty
7. Clicking an item could be a future feature - for now just display

Use lucide-react User icon for each list item.

Relative time helper (keep simple, static display):
```typescript
function getRelativeTime(timestamp: number): string {
  const now = Date.now();
  const diff = now - timestamp;
  const minutes = Math.floor(diff / 60000);
  const hours = Math.floor(diff / 3600000);
  const days = Math.floor(diff / 86400000);

  if (minutes < 1) return "Just now";
  if (minutes < 60) return `${minutes}m ago`;
  if (hours < 24) return `${hours}h ago`;
  if (days < 7) return `${days}d ago`;
  return new Date(timestamp).toLocaleDateString();
}
```
  </action>
  <verify>Component renders without errors. TypeScript compiles.</verify>
  <done>ActivityFeed displays recent submissions with names, forms, and timestamps.</done>
</task>

<task type="auto">
  <name>Task 3: Add Dashboard tab with ActivityFeed</name>
  <files>src/components/admin/AdminTabs.tsx</files>
  <action>
Add a "Dashboard" tab that shows the activity feed (and will contain stats in future integration).

Implementation:
1. Import ActivityFeed component
2. Add "Dashboard" as first tab in TabsList
3. Add TabsContent for "dashboard" value containing ActivityFeed
4. Update URL sync logic:
   - Default tab becomes "dashboard" instead of "submissions"
   - Remove tab param when "dashboard" is selected (cleaner URL)
5. Keep existing Submissions and Forms tabs

Tab order: Dashboard | Submissions | Forms

Note: Stats cards remain in AdminDashboard (above all tabs). Activity feed is tab-specific content.
  </action>
  <verify>Visit /admin - Dashboard tab is default, shows activity feed. Other tabs still work.</verify>
  <done>Dashboard tab exists with activity feed. Default tab changed from Submissions to Dashboard.</done>
</task>

</tasks>

<verification>
1. `npx convex dev` runs without errors
2. `npm run build` succeeds
3. Visit /admin - Dashboard tab is selected by default
4. Activity feed shows recent submissions with names, forms, relative times
5. Submit a new form - activity feed updates to show new submission
6. Submissions and Forms tabs still function correctly
</verification>

<success_criteria>
- Dashboard tab shows activity feed with recent submissions
- Each activity item shows submitter name, form name, relative time
- Activity feed updates reactively when new submissions arrive
- Dashboard is default tab (cleaner /admin URL)
- Existing Submissions and Forms tabs unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/19-dashboard-enhancement/19-02-SUMMARY.md`
</output>

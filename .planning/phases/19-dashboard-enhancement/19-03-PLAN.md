---
phase: 19-dashboard-enhancement
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/schema.ts
  - convex/submissions.ts
  - src/components/admin/NotesEditor.tsx
  - src/components/admin/SubmissionSheet.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can add internal notes to a submission"
    - "Admin can view existing notes on a submission"
    - "Admin can edit notes on a submission"
    - "Notes persist across sessions"
  artifacts:
    - path: "convex/schema.ts"
      provides: "submissions table with notes field"
      contains: "notes: v.optional(v.string())"
    - path: "convex/submissions.ts"
      provides: "updateNotes mutation"
      exports: ["updateNotes"]
    - path: "src/components/admin/NotesEditor.tsx"
      provides: "Notes textarea with save-on-blur"
      min_lines: 50
    - path: "src/components/admin/SubmissionSheet.tsx"
      provides: "Sheet with notes section"
      contains: "NotesEditor"
  key_links:
    - from: "src/components/admin/NotesEditor.tsx"
      to: "api.submissions.updateNotes"
      via: "useMutation hook"
      pattern: "useMutation.*api\\.submissions\\.updateNotes"
    - from: "src/components/admin/SubmissionSheet.tsx"
      to: "NotesEditor"
      via: "component import and render"
      pattern: "import.*NotesEditor"
---

<objective>
Add internal notes feature to submissions for admin collaboration.

Purpose: Admins can record observations, decisions, and context about submissions without affecting the applicant-visible data.
Output: NotesEditor component in SubmissionSheet, backed by notes field in submissions table.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-dashboard-enhancement/19-RESEARCH.md

@convex/schema.ts
@convex/submissions.ts
@src/components/admin/SubmissionSheet.tsx
@src/components/admin/DynamicEditableField.tsx
@src/components/ui/textarea.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add notes field to submissions schema</name>
  <files>convex/schema.ts</files>
  <action>
Add optional notes field to the submissions table.

Implementation:
1. Add `notes: v.optional(v.string())` to submissions table definition
2. Place after `submittedAt` field for logical grouping

The field is optional so existing submissions continue to work without migration.

After edit, submissions table should look like:
```typescript
submissions: defineTable({
  formVersionId: v.id("formVersions"),
  data: v.string(),
  status: v.union(
    v.literal("new"),
    v.literal("under_review"),
    v.literal("accepted"),
    v.literal("rejected")
  ),
  submittedAt: v.number(),
  notes: v.optional(v.string()), // NEW: Admin internal notes
})
  .index("by_version", ["formVersionId"])
  .index("by_status", ["status"])
  .index("by_submitted", ["submittedAt"]),
```
  </action>
  <verify>Run `npx convex dev` - schema pushes without errors.</verify>
  <done>submissions table has optional notes field.</done>
</task>

<task type="auto">
  <name>Task 2: Create updateNotes mutation</name>
  <files>convex/submissions.ts</files>
  <action>
Add mutation to update submission notes.

Implementation:
1. Add new mutation export `updateNotes`
2. Args: `submissionId: v.id("submissions"), notes: v.string()`
3. Verify submission exists
4. Patch submission with new notes value
5. Return submissionId for confirmation

```typescript
export const updateNotes = mutation({
  args: {
    submissionId: v.id("submissions"),
    notes: v.string(),
  },
  handler: async (ctx, args) => {
    const submission = await ctx.db.get(args.submissionId);
    if (!submission) throw new Error("Submission not found");

    await ctx.db.patch(args.submissionId, {
      notes: args.notes,
    });

    return args.submissionId;
  },
});
```

Also update `getWithSchema` query to include notes in the returned submission object (it already returns full submission, so notes will be included automatically once schema is updated).
  </action>
  <verify>Run `npx convex dev` - mutation appears in functions. No type errors.</verify>
  <done>updateNotes mutation saves notes to submission.</done>
</task>

<task type="auto">
  <name>Task 3: Create NotesEditor component</name>
  <files>src/components/admin/NotesEditor.tsx</files>
  <action>
Create a component for viewing and editing submission notes.

Implementation:
1. Create `NotesEditor.tsx` in `src/components/admin/`
2. Props: `submissionId: Id<"submissions">`, `initialNotes: string | undefined`
3. Follow DynamicEditableField pattern: save on blur with visual feedback
4. Use shadcn/ui Textarea component
5. Show "Add notes..." placeholder when empty
6. Visual states:
   - Default: Textarea with muted border
   - Focused/editing: Ring highlight
   - Saving: Disabled with subtle opacity
   - Saved: Brief success indication (optional)
7. Debounce is NOT needed - save on blur is sufficient
8. Handle Escape to cancel, Ctrl+Enter to save explicitly

Structure:
```tsx
interface NotesEditorProps {
  submissionId: Id<"submissions">;
  initialNotes?: string;
}

export function NotesEditor({ submissionId, initialNotes }: NotesEditorProps) {
  const [notes, setNotes] = useState(initialNotes ?? "");
  const [isSaving, setIsSaving] = useState(false);
  const updateNotes = useMutation(api.submissions.updateNotes);

  // Sync external value when not focused
  useEffect(() => { ... }, [initialNotes]);

  const handleSave = async () => {
    if (notes === (initialNotes ?? "")) return; // No change
    setIsSaving(true);
    try {
      await updateNotes({ submissionId, notes });
    } finally {
      setIsSaving(false);
    }
  };

  const handleBlur = () => handleSave();
  const handleKeyDown = (e) => {
    if (e.key === "Escape") { setNotes(initialNotes ?? ""); }
    if ((e.ctrlKey || e.metaKey) && e.key === "Enter") { handleSave(); }
  };

  return (
    <div className="space-y-2">
      <label className="text-sm font-medium">Internal Notes</label>
      <Textarea
        value={notes}
        onChange={(e) => setNotes(e.target.value)}
        onBlur={handleBlur}
        onKeyDown={handleKeyDown}
        placeholder="Add notes about this submission..."
        disabled={isSaving}
        rows={4}
        className="resize-none"
      />
      <p className="text-xs text-muted-foreground">
        Notes are only visible to admins. Press Ctrl+Enter to save.
      </p>
    </div>
  );
}
```
  </action>
  <verify>Component renders without errors. TypeScript compiles.</verify>
  <done>NotesEditor allows viewing/editing notes with save-on-blur.</done>
</task>

<task type="auto">
  <name>Task 4: Add NotesEditor to SubmissionSheet</name>
  <files>src/components/admin/SubmissionSheet.tsx</files>
  <action>
Integrate NotesEditor into the submission detail sheet.

Implementation:
1. Import NotesEditor component
2. Add NotesEditor section between Edit History and Footer
3. Pass submissionId and submission.notes as props
4. Add Separator before NotesEditor section
5. Wrap in Section component with title "Internal Notes"

Position in sheet (from top to bottom):
1. Header (form name, version, date)
2. Status section
3. Fields grouped by step
4. Separator
5. Edit History (collapsible)
6. Separator
7. **Internal Notes (NEW)**
8. Separator
9. Footer (submitted timestamp)

```tsx
{/* Edit History */}
<SubmissionEditHistory submissionId={submission._id} />

<Separator />

{/* Internal Notes */}
<Section title="Internal Notes">
  <NotesEditor
    submissionId={submission._id}
    initialNotes={submission.notes}
  />
</Section>

<Separator />

{/* Footer */}
```

Note: The submission object from getWithSchema already includes notes since we added it to the schema.
  </action>
  <verify>Open a submission - Notes section appears. Can add, edit, and save notes.</verify>
  <done>SubmissionSheet displays NotesEditor for internal notes.</done>
</task>

</tasks>

<verification>
1. `npx convex dev` runs without errors (schema + mutation)
2. `npm run build` succeeds
3. Open any submission in SubmissionSheet
4. Notes section visible below Edit History
5. Type notes, click away - notes save automatically
6. Refresh page - notes persist
7. Edit notes, press Escape - reverts to saved value
8. Notes are not visible in submissions table (internal only)
</verification>

<success_criteria>
- Admin can add notes to any submission
- Notes auto-save on blur (following project pattern)
- Notes persist across page refreshes
- Notes section clearly labeled as internal/admin-only
- Existing submissions without notes work correctly (optional field)
</success_criteria>

<output>
After completion, create `.planning/phases/19-dashboard-enhancement/19-03-SUMMARY.md`
</output>

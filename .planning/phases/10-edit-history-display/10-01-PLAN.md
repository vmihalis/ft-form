---
phase: 10-edit-history-display
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/ui/collapsible.tsx
  - src/lib/constants/fieldLabels.ts
  - src/components/admin/EditHistory.tsx
  - src/components/admin/ApplicationSheet.tsx
autonomous: false

must_haves:
  truths:
    - "Admin can see 'Edit History' section in application detail panel"
    - "Edit history section is collapsible (can expand/collapse)"
    - "Timeline shows field name, old value, new value, and timestamp for each edit"
    - "Most recent edits appear first in timeline"
    - "Field names display as human-readable labels (e.g., 'Floor' not 'floor')"
    - "Empty state shows 'No edits yet' message"
  artifacts:
    - path: "src/components/ui/collapsible.tsx"
      provides: "Radix Collapsible wrapper components"
      exports: ["Collapsible", "CollapsibleTrigger", "CollapsibleContent"]
    - path: "src/lib/constants/fieldLabels.ts"
      provides: "Technical field name to human-readable label mapping"
      exports: ["FIELD_LABELS", "getFieldLabel"]
    - path: "src/components/admin/EditHistory.tsx"
      provides: "Collapsible edit history timeline component"
      exports: ["EditHistory"]
  key_links:
    - from: "src/components/admin/EditHistory.tsx"
      to: "convex/applications.ts:getEditHistory"
      via: "useQuery hook"
      pattern: "useQuery.*getEditHistory"
    - from: "src/components/admin/EditHistory.tsx"
      to: "src/lib/constants/fieldLabels.ts"
      via: "getFieldLabel import"
      pattern: "getFieldLabel"
    - from: "src/components/admin/ApplicationSheet.tsx"
      to: "src/components/admin/EditHistory.tsx"
      via: "EditHistory component import"
      pattern: "import.*EditHistory"
---

<objective>
Create a collapsible "Edit History" section in the ApplicationSheet detail panel that displays a timeline of all field edits with human-readable field names.

Purpose: Complete the v1.1 Admin Inline Editing milestone by making edit history visible to admins (HIST-02, HIST-03, HIST-04).
Output: EditHistory component integrated into ApplicationSheet, field label mapping constant.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-edit-infrastructure/08-01-SUMMARY.md
@.planning/phases/09-inline-editing-ui/09-01-SUMMARY.md

# Key source files
@convex/applications.ts (getEditHistory query already exists)
@convex/schema.ts (editHistory table schema)
@src/components/admin/ApplicationSheet.tsx (integration point)
@src/components/ui/separator.tsx (shadcn pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Collapsible UI component and field labels constant</name>
  <files>
    - package.json
    - src/components/ui/collapsible.tsx
    - src/lib/constants/fieldLabels.ts
  </files>
  <action>
1. Install @radix-ui/react-collapsible:
   ```bash
   npm install @radix-ui/react-collapsible
   ```

2. Create `src/components/ui/collapsible.tsx` following shadcn pattern (see separator.tsx):
   ```tsx
   "use client";

   import * as CollapsiblePrimitive from "@radix-ui/react-collapsible";

   export const Collapsible = CollapsiblePrimitive.Root;
   export const CollapsibleTrigger = CollapsiblePrimitive.Trigger;
   export const CollapsibleContent = CollapsiblePrimitive.Content;
   ```

3. Create `src/lib/constants/fieldLabels.ts` with complete field-to-label mapping:
   ```typescript
   /**
    * Maps technical field names to human-readable labels.
    * Used in EditHistory timeline display (HIST-04).
    * Labels sourced from ApplicationSheet EditableField labels.
    */
   export const FIELD_LABELS: Record<string, string> = {
     // Applicant Info
     fullName: "Name",
     email: "Email",
     linkedIn: "LinkedIn",
     role: "Role",
     bio: "Bio",
     // Proposal
     floor: "Floor",
     initiativeName: "Initiative Name",
     tagline: "Tagline",
     values: "Core Values",
     targetCommunity: "Target Community",
     estimatedSize: "Estimated Community Size",
     additionalNotes: "Additional Notes",
     // Roadmap
     phase1Mvp: "Phase 1: MVP (First 3 months)",
     phase2Expansion: "Phase 2: Expansion (3-6 months)",
     phase3LongTerm: "Phase 3: Long-term (6+ months)",
     // Impact
     benefitToFT: "Benefit to Frontier Tower",
     // Logistics
     existingCommunity: "Existing Community",
     spaceNeeds: "Space Needs",
     startDate: "Earliest Start Date",
   };

   /**
    * Get human-readable label for a field name.
    * Falls back to field name if not found.
    */
   export function getFieldLabel(field: string): string {
     return FIELD_LABELS[field] ?? field;
   }
   ```
  </action>
  <verify>
    - `npm ls @radix-ui/react-collapsible` shows package installed
    - `cat src/components/ui/collapsible.tsx` shows exports
    - `cat src/lib/constants/fieldLabels.ts` shows all 19 field mappings
    - TypeScript compilation: `npx tsc --noEmit` passes
  </verify>
  <done>
    - Collapsible UI component exists with Root, Trigger, Content exports
    - Field labels constant maps all 19 application fields to human-readable names
    - getFieldLabel helper returns label or falls back to field name
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EditHistory component and integrate into ApplicationSheet</name>
  <files>
    - src/components/admin/EditHistory.tsx
    - src/components/admin/ApplicationSheet.tsx
  </files>
  <action>
1. Create `src/components/admin/EditHistory.tsx`:
   - Use Convex `useQuery` to call `getEditHistory` with applicationId prop
   - Wrap in Collapsible component (default closed)
   - CollapsibleTrigger: "Edit History" header with ChevronDown/ChevronRight icon that rotates
   - CollapsibleContent: Timeline of edits or "No edits yet" empty state
   - Each edit entry shows:
     - Field label (via getFieldLabel)
     - Old value -> New value (truncate to 100 chars with ellipsis if longer)
     - Timestamp (toLocaleString for timezone handling)
   - For floor/estimatedSize fields, use getFloorLabel/getEstimatedSizeLabel helpers for values
   - Style: muted text, compact layout, vertical timeline with left border

   ```tsx
   "use client";

   import { useState } from "react";
   import { useQuery } from "convex/react";
   import { api } from "../../../convex/_generated/api";
   import { Id } from "../../../convex/_generated/dataModel";
   import { ChevronRight } from "lucide-react";
   import {
     Collapsible,
     CollapsibleContent,
     CollapsibleTrigger,
   } from "@/components/ui/collapsible";
   import { getFieldLabel } from "@/lib/constants/fieldLabels";
   import { getFloorLabel } from "@/lib/constants/floors";
   import { getEstimatedSizeLabel } from "@/lib/constants/estimatedSizes";
   import { cn } from "@/lib/utils";

   interface EditHistoryProps {
     applicationId: Id<"applications">;
   }

   function truncateValue(value: string, maxLength = 100): string {
     if (value.length <= maxLength) return value;
     return value.slice(0, maxLength) + "...";
   }

   function formatValue(field: string, value: string): string {
     if (field === "floor") return getFloorLabel(value);
     if (field === "estimatedSize") return getEstimatedSizeLabel(value);
     return truncateValue(value);
   }

   export function EditHistory({ applicationId }: EditHistoryProps) {
     const [isOpen, setIsOpen] = useState(false);
     const history = useQuery(api.applications.getEditHistory, { applicationId });

     if (history === undefined) {
       return null; // Loading
     }

     return (
       <Collapsible open={isOpen} onOpenChange={setIsOpen}>
         <CollapsibleTrigger className="flex items-center gap-2 w-full text-left font-medium hover:text-foreground/80 transition-colors">
           <ChevronRight
             className={cn(
               "h-4 w-4 transition-transform",
               isOpen && "rotate-90"
             )}
           />
           Edit History
           {history.length > 0 && (
             <span className="text-sm font-normal text-muted-foreground">
               ({history.length})
             </span>
           )}
         </CollapsibleTrigger>
         <CollapsibleContent className="pt-3">
           {history.length === 0 ? (
             <p className="text-sm text-muted-foreground italic">No edits yet</p>
           ) : (
             <div className="space-y-3 border-l-2 border-muted pl-4">
               {history.map((edit) => (
                 <div key={edit._id} className="text-sm">
                   <p className="font-medium">{getFieldLabel(edit.field)}</p>
                   <p className="text-muted-foreground">
                     <span className="line-through">
                       {formatValue(edit.field, edit.oldValue) || "(empty)"}
                     </span>
                     {" â†’ "}
                     <span>{formatValue(edit.field, edit.newValue) || "(empty)"}</span>
                   </p>
                   <p className="text-xs text-muted-foreground">
                     {new Date(edit.editedAt).toLocaleString()}
                   </p>
                 </div>
               ))}
             </div>
           )}
         </CollapsibleContent>
       </Collapsible>
     );
   }
   ```

2. Update `src/components/admin/ApplicationSheet.tsx`:
   - Add import: `import { EditHistory } from "./EditHistory";`
   - Add EditHistory section after Logistics section, before the "Submitted on" footer
   - Wrap in Section component with title (actually EditHistory has its own header, so just add Separator + EditHistory directly)

   After the Logistics Section and Separator, before the footer `<p>`:
   ```tsx
   {/* Edit History */}
   <EditHistory applicationId={application._id} />

   <Separator />
   ```
  </action>
  <verify>
    - TypeScript compilation: `npx tsc --noEmit` passes
    - No console errors when viewing an application in admin dashboard
    - `grep -r "EditHistory" src/components/admin/` shows both files
  </verify>
  <done>
    - EditHistory component displays collapsible timeline with field labels
    - Empty state shows "No edits yet"
    - ApplicationSheet includes EditHistory section before footer
    - Floor and estimatedSize values display as human-readable labels
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Edit History timeline in ApplicationSheet detail panel</what-built>
  <how-to-verify>
    1. Run `npm run dev` and visit http://localhost:3000/admin
    2. Login and click any application to open detail panel
    3. Verify "Edit History" section appears (collapsed by default)
    4. Click to expand - should show "No edits yet" if no edits, or timeline of edits
    5. Make an edit to a field (e.g., change the Name)
    6. Collapse and re-expand Edit History - new edit should appear at top
    7. Verify:
       - Field name shows as "Name" not "fullName"
       - Old and new values displayed correctly
       - Timestamp shows readable date/time
       - If editing Floor, label shows "Floor 9 - AI & Autonomous Systems" not "floor-9"
    8. Make multiple edits and verify most recent appears first
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
- [ ] `@radix-ui/react-collapsible` installed
- [ ] Collapsible UI component exports three primitives
- [ ] Field labels constant covers all 19 fields
- [ ] EditHistory component uses getEditHistory query
- [ ] ApplicationSheet includes EditHistory section
- [ ] Timeline shows most recent edits first (HIST-03)
- [ ] Field names display as human-readable labels (HIST-04)
- [ ] Edit history viewable in detail panel (HIST-02)
</verification>

<success_criteria>
1. Detail panel shows collapsible "Edit History" section
2. Timeline displays all edits with field name, old value, new value, and timestamp
3. Most recent edits appear first in the timeline
4. Field names display as human-readable labels (e.g., "Floor" not "floor")
5. Empty state handled gracefully
6. Floor and estimatedSize values show human-readable labels
</success_criteria>

<output>
After completion, create `.planning/phases/10-edit-history-display/10-01-SUMMARY.md`
</output>

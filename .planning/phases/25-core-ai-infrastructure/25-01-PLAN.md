---
phase: 25-core-ai-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/ai/schemas.ts
  - src/lib/ai/validate-schema.ts
  - src/lib/ai/api-key.ts
autonomous: true

must_haves:
  truths:
    - "Zod schemas exactly mirror FormSchema TypeScript interface"
    - "AI-generated forms can be validated before display"
    - "Duplicate field IDs are detected and rejected"
    - "Select/radio fields without options are detected and rejected"
  artifacts:
    - path: "src/lib/ai/schemas.ts"
      provides: "Zod schemas for AI output validation"
      exports: ["FieldTypeSchema", "FormFieldSchema", "FormStepSchema", "FormSettingsSchema", "AIFormSchemaOutput"]
    - path: "src/lib/ai/validate-schema.ts"
      provides: "Validation helper with semantic checks"
      exports: ["validateAIFormSchema"]
    - path: "src/lib/ai/api-key.ts"
      provides: "API key format validation"
      exports: ["isValidOpenRouterKeyFormat"]
  key_links:
    - from: "src/lib/ai/schemas.ts"
      to: "src/types/form-schema.ts"
      via: "Type structure mirrors exactly"
      pattern: "FieldType.*text.*email.*textarea"
---

<objective>
Create Zod schemas for AI output validation that exactly mirror the existing FormSchema interface

Purpose: Enable robust validation of AI-generated form structures before they're displayed or stored. This is the foundation that prevents invalid forms from breaking the system.

Output: Three files in src/lib/ai/ providing type-safe validation for AI outputs
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-core-ai-infrastructure/25-RESEARCH.md

# Critical reference - schemas must mirror this exactly
@src/types/form-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas mirroring FormSchema interface</name>
  <files>src/lib/ai/schemas.ts</files>
  <action>
Create Zod schemas that exactly match the TypeScript interfaces in src/types/form-schema.ts:

1. Create FieldTypeSchema as z.enum with exactly these 10 types:
   - "text", "email", "url", "textarea", "number", "date", "select", "radio", "checkbox", "file"

2. Create FieldOptionSchema with:
   - value: z.string()
   - label: z.string()

3. Create FieldValidationSchema with all optional fields:
   - minLength: z.number().optional()
   - maxLength: z.number().optional()
   - min: z.number().optional()
   - max: z.number().optional()
   - pattern: z.string().optional()
   - customMessage: z.string().optional()

4. Create FormFieldSchema with:
   - id: z.string()
   - type: FieldTypeSchema
   - label: z.string()
   - description: z.string().optional()
   - placeholder: z.string().optional()
   - required: z.boolean()
   - validation: FieldValidationSchema.optional()
   - options: z.array(FieldOptionSchema).optional()

5. Create FormStepSchema with:
   - id: z.string()
   - title: z.string()
   - description: z.string().optional()
   - fields: z.array(FormFieldSchema)

6. Create FormSettingsSchema with:
   - submitButtonText: z.string()
   - successMessage: z.string()
   - welcomeMessage: z.string().optional()

7. Create AIFormSchemaOutput with:
   - steps: z.array(FormStepSchema)
   - settings: FormSettingsSchema

8. Export the inferred TypeScript type: `export type AIFormSchemaOutput = z.infer<typeof AIFormSchemaOutput>`

Use zod@^4.3.6 which is already installed. Import as `import { z } from 'zod'`.
  </action>
  <verify>
TypeScript compiles without errors: `pnpm build`

Manual verification: The schema types should be assignable to FormSchema from src/types/form-schema.ts.
  </verify>
  <done>
All Zod schemas are exported and TypeScript compiles successfully. The schemas mirror the FormSchema interface exactly with the same field names, types, and optionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create validation helper with semantic checks</name>
  <files>src/lib/ai/validate-schema.ts, src/lib/ai/api-key.ts</files>
  <action>
Create src/lib/ai/validate-schema.ts:

1. Import AIFormSchemaOutput from './schemas'

2. Create validateAIFormSchema function that takes `unknown` input and returns:
   ```typescript
   {
     success: boolean;
     data?: AIFormSchemaOutput;
     errors?: string[];
   }
   ```

3. Implementation:
   - First run AIFormSchemaOutput.safeParse(raw)
   - If parse fails, extract errors as "path.to.field: error message" strings
   - If parse succeeds, run semantic validation:
     a. Check for duplicate field IDs across ALL steps
     b. Check that select/radio fields have non-empty options array
     c. Check that checkbox fields have options if used as multi-select
   - Return success: true only if both structural and semantic validation pass

4. Error formatting should be user-friendly:
   - "steps.0.fields.1.type: Invalid enum value" -> keep as-is
   - Duplicate IDs: "Duplicate field IDs: email, name"
   - Missing options: "field_id: select/radio fields require options"

Create src/lib/ai/api-key.ts:

1. Export isValidOpenRouterKeyFormat function:
   ```typescript
   export function isValidOpenRouterKeyFormat(key: string): boolean {
     return (
       typeof key === 'string' &&
       key.startsWith('sk-or-') &&
       key.length > 20
     );
   }
   ```

This validates key format before making API calls to give early errors.
  </action>
  <verify>
TypeScript compiles: `pnpm build`

The validation helper correctly:
- Returns success: false for invalid JSON structure
- Returns success: false for duplicate field IDs
- Returns success: false for select fields without options
- Returns success: true for valid FormSchema structures
  </verify>
  <done>
validateAIFormSchema is exported and correctly validates both structure (via Zod) and semantics (duplicate IDs, required options). isValidOpenRouterKeyFormat is exported for API key format checking.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds without type errors
2. All exports are properly typed and accessible from other files
3. Zod schemas match FormSchema interface exactly (10 field types, same structure)
</verification>

<success_criteria>
- src/lib/ai/schemas.ts exports AIFormSchemaOutput and all sub-schemas
- src/lib/ai/validate-schema.ts exports validateAIFormSchema function
- src/lib/ai/api-key.ts exports isValidOpenRouterKeyFormat function
- TypeScript compilation passes
- Schema validation catches invalid field types, duplicate IDs, and missing options
</success_criteria>

<output>
After completion, create `.planning/phases/25-core-ai-infrastructure/25-01-SUMMARY.md`
</output>

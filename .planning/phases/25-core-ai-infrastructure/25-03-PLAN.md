---
phase: 25-core-ai-infrastructure
plan: 03
type: execute
wave: 2
depends_on: ["25-01", "25-02"]
files_modified:
  - package.json
  - src/app/api/ai/generate/route.ts
autonomous: true

user_setup:
  - service: openrouter
    why: "User-provided API key for LLM access (per architecture decision)"
    env_vars: []
    dashboard_config:
      - task: "Create OpenRouter account and get API key"
        location: "https://openrouter.ai/keys"
        note: "Key starts with sk-or-. User provides key in UI, not stored server-side."

must_haves:
  truths:
    - "Admin can enter a natural language prompt describing a form"
    - "AI responses stream to the UI with visible progress"
    - "Invalid API keys return clear error message, not cryptic failure"
    - "API route accepts user-provided API key per-request"
  artifacts:
    - path: "src/app/api/ai/generate/route.ts"
      provides: "Streaming AI endpoint for form generation"
      exports: ["POST"]
      contains: "streamText"
    - path: "package.json"
      provides: "AI SDK dependencies installed"
      contains: "@openrouter/ai-sdk-provider"
  key_links:
    - from: "src/app/api/ai/generate/route.ts"
      to: "src/lib/ai/system-prompt.ts"
      via: "Import system prompt"
      pattern: "import.*FORM_CREATION_SYSTEM_PROMPT"
    - from: "src/app/api/ai/generate/route.ts"
      to: "src/lib/ai/error-handling.ts"
      via: "Import error transformer"
      pattern: "import.*transformAIError"
    - from: "src/app/api/ai/generate/route.ts"
      to: "OpenRouter API"
      via: "createOpenRouter provider"
      pattern: "createOpenRouter"
---

<objective>
Create the streaming AI API route with OpenRouter integration

Purpose: This is the core endpoint that connects the frontend to OpenRouter's LLM API. It handles streaming responses, API key validation, and error transformation - making AI form generation actually work.

Output: Installed AI SDK packages and working streaming API endpoint
</objective>

<execution_context>
@/Users/memehalis/.claude/get-shit-done/workflows/execute-plan.md
@/Users/memehalis/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-core-ai-infrastructure/25-RESEARCH.md

# Dependencies from prior plans (Wave 1)
@src/lib/ai/schemas.ts
@src/lib/ai/system-prompt.ts
@src/lib/ai/error-handling.ts
@src/lib/ai/api-key.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install AI SDK dependencies</name>
  <files>package.json</files>
  <action>
Install the required packages using pnpm:

```bash
pnpm add ai@^6.0.69 @ai-sdk/react@^3.0.71 @openrouter/ai-sdk-provider@^2.1.1
```

These are:
- `ai`: Vercel AI SDK v6 core - provides streamText, generateText
- `@ai-sdk/react`: React hooks for chat UI (useChat) - used in Phase 26
- `@openrouter/ai-sdk-provider`: Official OpenRouter provider for AI SDK

Note: zod is already installed (^4.3.6) - no need to add it.

After installation, verify packages are in package.json dependencies section.
  </action>
  <verify>
Run `pnpm ls ai @ai-sdk/react @openrouter/ai-sdk-provider` to confirm packages installed.

Check package.json contains the three new dependencies.
  </verify>
  <done>
AI SDK packages are installed: ai@^6.x, @ai-sdk/react@^3.x, @openrouter/ai-sdk-provider@^2.x
  </done>
</task>

<task type="auto">
  <name>Task 2: Create streaming AI API route</name>
  <files>src/app/api/ai/generate/route.ts</files>
  <action>
Create the streaming API endpoint following AI SDK v6 patterns:

1. Create directory structure: src/app/api/ai/generate/

2. Create route.ts with:

```typescript
import { createOpenRouter } from '@openrouter/ai-sdk-provider';
import { streamText } from 'ai';
import { FORM_CREATION_SYSTEM_PROMPT } from '@/lib/ai/system-prompt';
import { transformAIError } from '@/lib/ai/error-handling';
import { isValidOpenRouterKeyFormat } from '@/lib/ai/api-key';

// Allow up to 60s for complex form generation
export const maxDuration = 60;

export async function POST(req: Request) {
  try {
    const { messages, apiKey } = await req.json();

    // Validate API key format early
    if (!apiKey || !isValidOpenRouterKeyFormat(apiKey)) {
      return Response.json(
        {
          error: 'Valid OpenRouter API key required',
          actionable: 'Please enter your OpenRouter API key (starts with sk-or-).',
        },
        { status: 401 }
      );
    }

    // Create OpenRouter provider with user's key
    const openrouter = createOpenRouter({
      apiKey,
      headers: {
        'HTTP-Referer': 'https://frontiertower.com',
        'X-Title': 'FrontierOS Form Builder',
      },
    });

    // Stream response from Claude
    const result = streamText({
      model: openrouter('anthropic/claude-sonnet-4'),
      system: FORM_CREATION_SYSTEM_PROMPT,
      messages,
    });

    // Return streaming response in AI SDK format
    return result.toUIMessageStreamResponse();
  } catch (error) {
    // Transform error to user-friendly message
    const transformed = transformAIError(error);
    return Response.json(
      { error: transformed.message, actionable: transformed.actionable },
      { status: transformed.status }
    );
  }
}
```

Key implementation details:
- maxDuration = 60 prevents timeout on complex forms
- API key passed per-request, NOT stored server-side
- Uses isValidOpenRouterKeyFormat for early validation
- OpenRouter headers identify the application
- Model: anthropic/claude-sonnet-4 via OpenRouter (can change later)
- streamText returns streaming response, toUIMessageStreamResponse() formats for AI SDK React hooks
- All errors go through transformAIError for user-friendly messages
  </action>
  <verify>
1. TypeScript compiles: `pnpm build`
2. Route file exists at correct path
3. Imports resolve correctly (no missing module errors)
4. Manual test with curl (optional - requires valid API key):
   ```bash
   curl -X POST http://localhost:3000/api/ai/generate \
     -H "Content-Type: application/json" \
     -d '{"messages":[{"role":"user","content":"Create a simple contact form"}],"apiKey":"sk-or-test"}'
   ```
   Should return 401 with actionable error (test key is invalid format but demonstrates endpoint works)
  </verify>
  <done>
API route is created at /api/ai/generate, accepts POST with {messages, apiKey}, streams responses via AI SDK, and returns user-friendly errors for all failure cases.
  </done>
</task>

</tasks>

<verification>
1. `pnpm build` succeeds - all imports resolve, TypeScript compiles
2. AI SDK packages in node_modules: ai, @ai-sdk/react, @openrouter/ai-sdk-provider
3. API route exports POST handler at /api/ai/generate
4. Route imports from all three ai/* utility files created in Wave 1
</verification>

<success_criteria>
- AI SDK packages installed: ai@^6.x, @ai-sdk/react@^3.x, @openrouter/ai-sdk-provider@^2.x
- API route created at src/app/api/ai/generate/route.ts
- Route accepts {messages, apiKey} in POST body
- Invalid API key returns 401 with actionable message
- Valid requests stream responses via toUIMessageStreamResponse()
- All errors transformed to user-friendly messages
- TypeScript compilation passes
- maxDuration set to 60 for complex form generation
</success_criteria>

<output>
After completion, create `.planning/phases/25-core-ai-infrastructure/25-03-SUMMARY.md`
</output>

---
phase: 02-form-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/lib/schemas/application.ts
  - src/lib/stores/form-store.ts
  - src/types/form.ts
autonomous: true

must_haves:
  truths:
    - "Zod schemas exist for each form step with proper validation rules"
    - "Zustand store can track current step and save/restore form data"
    - "TypeScript types are inferred from Zod schemas"
  artifacts:
    - path: "src/lib/schemas/application.ts"
      provides: "Per-step Zod schemas and combined schema"
      exports: ["applicantInfoSchema", "proposalSchema", "roadmapSchema", "impactSchema", "logisticsSchema", "combinedApplicationSchema", "stepSchemas", "stepFields"]
    - path: "src/lib/stores/form-store.ts"
      provides: "Zustand store with localStorage persistence"
      exports: ["useFormStore"]
    - path: "src/types/form.ts"
      provides: "TypeScript type definitions for form data"
      exports: ["ApplicationFormData", "FormStep"]
  key_links:
    - from: "src/lib/schemas/application.ts"
      to: "convex/schema.ts"
      via: "Field names match database schema"
      pattern: "fullName|email|floor|initiativeName"
    - from: "src/lib/stores/form-store.ts"
      to: "localStorage"
      via: "Zustand persist middleware"
      pattern: "persist.*ft-form-draft"
---

<objective>
Install form infrastructure packages and create the foundational schemas and state management for the multi-step form.

Purpose: Establish the data contracts (Zod schemas) and state management (Zustand store) that all form components will depend on. This is the invisible backbone that enables validation, persistence, and navigation.

Output: Working schemas that match the Convex database fields, Zustand store with localStorage persistence, and TypeScript types inferred from schemas.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-form-infrastructure/02-RESEARCH.md
@convex/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install form infrastructure packages</name>
  <files>package.json</files>
  <action>
    Install the form infrastructure stack:
    ```bash
    npm install react-hook-form @hookform/resolvers zod zustand
    ```

    These packages provide:
    - react-hook-form: Form state management with minimal re-renders
    - @hookform/resolvers: Connects Zod to React Hook Form
    - zod: Schema validation with TypeScript inference
    - zustand: Lightweight state management with persist middleware

    Verify packages are added to package.json dependencies.
  </action>
  <verify>
    Run `npm ls react-hook-form zod zustand @hookform/resolvers` and confirm all packages installed.
    Check package.json includes all four dependencies.
  </verify>
  <done>All four packages appear in package.json dependencies and are installed in node_modules.</done>
</task>

<task type="auto">
  <name>Task 2: Create Zod validation schemas</name>
  <files>src/lib/schemas/application.ts, src/types/form.ts</files>
  <action>
    Create `src/lib/schemas/application.ts` with per-step validation schemas.

    **Step schemas (must match convex/schema.ts field names exactly):**

    1. `applicantInfoSchema`: fullName (required), email (valid email), linkedIn (optional URL or empty string), role (required), bio (min 50 chars)

    2. `proposalSchema`: floor (required), floorOther (optional), initiativeName (required), tagline (required, max 100 chars), values (min 20 chars), targetCommunity (min 20 chars), estimatedSize (required)

    3. `roadmapSchema`: phase1Mvp (min 50 chars), phase2Expansion (min 50 chars), phase3LongTerm (min 50 chars)

    4. `impactSchema`: benefitToFT (min 50 chars)

    5. `logisticsSchema`: existingCommunity (required), spaceNeeds (required), startDate (required), additionalNotes (optional)

    **Also create:**
    - `combinedApplicationSchema`: Merge of all step schemas
    - `stepSchemas`: Array mapping step index to schema (null for Welcome, Review, Confirmation)
    - `stepFields`: Array mapping step index to field names for trigger() validation

    Create `src/types/form.ts` with:
    - `ApplicationFormData`: Type inferred from combinedApplicationSchema
    - `FormStep`: Enum or type for step identifiers (0-7)
    - `TOTAL_STEPS`: Constant = 8
    - `FORM_STEPS`: Array of step metadata (id, label, hasValidation)

    **Important:** Use `z.string().url().optional().or(z.literal(""))` pattern for optional URL fields to handle empty strings properly.
  </action>
  <verify>
    Create a test file and run TypeScript compilation:
    ```bash
    npx tsc --noEmit
    ```
    Should compile without errors. Verify type inference works by checking ApplicationFormData has all expected fields.
  </verify>
  <done>
    - src/lib/schemas/application.ts exports all 5 step schemas, combined schema, stepSchemas array, and stepFields array
    - src/types/form.ts exports ApplicationFormData type, FormStep type, TOTAL_STEPS, and FORM_STEPS
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Zustand store with localStorage persistence</name>
  <files>src/lib/stores/form-store.ts</files>
  <action>
    Create `src/lib/stores/form-store.ts` with a Zustand store using persist middleware.

    **Store state:**
    - `currentStep: number` - Current step index (0-7)
    - `completedSteps: number[]` - Array of completed step indexes
    - `formData: Partial<ApplicationFormData>` - Current form values
    - `isHydrated: boolean` - Whether store has rehydrated from localStorage

    **Store actions:**
    - `setCurrentStep(step: number)` - Navigate to step
    - `markStepCompleted(step: number)` - Add step to completedSteps
    - `updateFormData(data: Partial<ApplicationFormData>)` - Merge new data
    - `resetForm()` - Reset to initial state and clear localStorage
    - `setHydrated(value: boolean)` - Mark hydration complete

    **Persist configuration:**
    - `name: "ft-form-draft"` - localStorage key
    - `storage: createJSONStorage(() => localStorage)`
    - `skipHydration: true` - Critical for Next.js SSR (prevents hydration mismatch)
    - `partialize: (state) => ({ currentStep, completedSteps, formData })` - Only persist these fields, not isHydrated

    **Important patterns:**
    - Mark as "use client" directive
    - Import ApplicationFormData from types/form.ts
    - Export useFormStore hook
    - Include onRehydrateStorage callback to set isHydrated = true after rehydration
  </action>
  <verify>
    TypeScript compilation passes:
    ```bash
    npx tsc --noEmit
    ```
    Store exports useFormStore hook with correct types.
  </verify>
  <done>
    - src/lib/stores/form-store.ts exports useFormStore hook
    - Store has all state fields: currentStep, completedSteps, formData, isHydrated
    - Store has all actions: setCurrentStep, markStepCompleted, updateFormData, resetForm, setHydrated
    - Persist middleware configured with skipHydration: true
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Package installation:**
   ```bash
   npm ls react-hook-form zod zustand @hookform/resolvers
   ```
   All four packages listed at expected versions.

2. **TypeScript compilation:**
   ```bash
   npx tsc --noEmit
   ```
   No errors. Schema types correctly inferred.

3. **Schema field alignment:**
   Verify field names in application.ts match convex/schema.ts exactly (fullName, email, linkedIn, role, bio, floor, floorOther, initiativeName, tagline, values, targetCommunity, estimatedSize, phase1Mvp, phase2Expansion, phase3LongTerm, benefitToFT, existingCommunity, spaceNeeds, startDate, additionalNotes).

4. **Store structure:**
   Verify useFormStore exports type includes all state and actions.
</verification>

<success_criteria>
- Four npm packages installed: react-hook-form, @hookform/resolvers, zod, zustand
- Zod schemas exist for all 5 form steps with appropriate validation rules
- Combined schema merges all step schemas
- stepSchemas and stepFields arrays enable per-step validation
- Zustand store persists to localStorage under "ft-form-draft" key
- skipHydration: true prevents SSR hydration mismatches
- TypeScript compiles with no errors
- All field names match Convex schema exactly
</success_criteria>

<output>
After completion, create `.planning/phases/02-form-infrastructure/02-01-SUMMARY.md`
</output>

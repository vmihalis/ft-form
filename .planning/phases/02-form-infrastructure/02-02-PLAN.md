---
phase: 02-form-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/form/MultiStepForm.tsx
  - src/components/form/ProgressIndicator.tsx
  - src/components/form/NavigationButtons.tsx
  - src/components/form/StoreHydration.tsx
  - src/components/form/StepContent.tsx
  - src/app/apply/page.tsx
autonomous: true

must_haves:
  truths:
    - "Form state persists when navigating back and forward between steps"
    - "User cannot advance to next step until current step validates successfully"
    - "Refreshing the browser restores form progress from localStorage"
    - "Progress indicator shows correct step number out of total steps"
    - "Back navigation works without triggering validation"
  artifacts:
    - path: "src/components/form/MultiStepForm.tsx"
      provides: "Main form container with FormProvider"
      exports: ["MultiStepForm"]
      min_lines: 40
    - path: "src/components/form/ProgressIndicator.tsx"
      provides: "Visual step indicator with accessibility"
      exports: ["ProgressIndicator"]
      min_lines: 30
    - path: "src/components/form/NavigationButtons.tsx"
      provides: "Back/Next buttons with validation logic"
      exports: ["NavigationButtons"]
      min_lines: 50
    - path: "src/components/form/StoreHydration.tsx"
      provides: "SSR-safe store rehydration"
      exports: ["StoreHydration"]
    - path: "src/components/form/StepContent.tsx"
      provides: "Step renderer (placeholder for Phase 3)"
      exports: ["StepContent"]
    - path: "src/app/apply/page.tsx"
      provides: "Updated apply page with MultiStepForm"
  key_links:
    - from: "src/components/form/MultiStepForm.tsx"
      to: "src/lib/stores/form-store.ts"
      via: "useFormStore hook"
      pattern: "useFormStore"
    - from: "src/components/form/NavigationButtons.tsx"
      to: "src/lib/schemas/application.ts"
      via: "stepFields for validation"
      pattern: "stepFields\\[currentStep\\]"
    - from: "src/components/form/MultiStepForm.tsx"
      to: "react-hook-form"
      via: "FormProvider context"
      pattern: "FormProvider.*methods"
    - from: "src/app/apply/page.tsx"
      to: "src/components/form/MultiStepForm.tsx"
      via: "Component import"
      pattern: "import.*MultiStepForm"
---

<objective>
Create the form container components that wire together React Hook Form, Zustand store, and navigation logic.

Purpose: Build the working form shell that enables step navigation, per-step validation, and localStorage persistence. After this plan, clicking Next validates the current step, clicking Back always works, and refreshing restores progress.

Output: Functional multi-step form container with progress indicator and navigation. Steps show placeholder content (Phase 3 builds actual step UI).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-form-infrastructure/02-RESEARCH.md
@.planning/phases/02-form-infrastructure/02-01-SUMMARY.md
@src/lib/schemas/application.ts
@src/lib/stores/form-store.ts
@src/types/form.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create StoreHydration and StepContent components</name>
  <files>src/components/form/StoreHydration.tsx, src/components/form/StepContent.tsx</files>
  <action>
    Create `src/components/form/StoreHydration.tsx`:
    - "use client" directive
    - useEffect that calls `useFormStore.persist.rehydrate()` on mount
    - Also set `setHydrated(true)` after rehydration
    - Return null (renders nothing, just side effect)

    Create `src/components/form/StepContent.tsx`:
    - "use client" directive
    - Accept `step: number` prop
    - Return placeholder content for each step showing step name
    - Use FORM_STEPS from types/form.ts to get step labels
    - Wrap in a div with consistent styling (padding, centered text)
    - This is a placeholder - Phase 3 will replace with actual step components

    **Step labels for placeholder:**
    - 0: Welcome
    - 1: About You
    - 2: Your Proposal
    - 3: Roadmap
    - 4: Impact
    - 5: Logistics
    - 6: Review
    - 7: Confirmation
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    npx tsc --noEmit
    ```
    Both components export correctly.
  </verify>
  <done>
    - StoreHydration.tsx calls persist.rehydrate() in useEffect
    - StepContent.tsx renders step label based on step prop
    - Both marked as client components
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create ProgressIndicator and NavigationButtons components</name>
  <files>src/components/form/ProgressIndicator.tsx, src/components/form/NavigationButtons.tsx</files>
  <action>
    Create `src/components/form/ProgressIndicator.tsx`:
    - "use client" directive
    - Read currentStep and completedSteps from useFormStore
    - Render horizontal step indicators (numbered circles with connecting lines)
    - Current step: filled primary color
    - Completed steps: checkmark icon with primary background
    - Future steps: gray outline
    - Add accessibility: `aria-label="Form progress"`, `aria-current="step"` on current, `sr-only` text for screen readers
    - Use FORM_STEPS from types/form.ts for step count
    - Use cn() utility for conditional classes
    - Use Check icon from lucide-react for completed steps
    - Don't show labels on small screens (just numbered circles), show "Step X of Y" as sr-only

    Create `src/components/form/NavigationButtons.tsx`:
    - "use client" directive
    - Read currentStep from useFormStore
    - Get trigger, getValues from useFormContext
    - Import stepFields from schemas/application.ts

    **handleNext logic:**
    1. Get fields for current step from stepFields[currentStep]
    2. If fields exist, call `await trigger(fieldsToValidate)`
    3. If validation fails, return early (errors show automatically)
    4. If valid, call updateFormData(getValues()) to sync to Zustand
    5. Call markStepCompleted(currentStep)
    6. Call setCurrentStep(currentStep + 1)

    **handleBack logic:**
    1. Call updateFormData(getValues()) to save current values (even invalid)
    2. Call setCurrentStep(currentStep - 1)
    3. NO validation - back always works

    **Button visibility:**
    - Step 0 (Welcome): Only "Begin" button (acts as Next)
    - Steps 1-5: Both Back and Next
    - Step 6 (Review): Back and "Submit Application" (type="submit")
    - Step 7 (Confirmation): No buttons

    Use Button component from @/components/ui/button with appropriate variants.
  </action>
  <verify>
    TypeScript compiles:
    ```bash
    npx tsc --noEmit
    ```
    Components use correct hooks and imports.
  </verify>
  <done>
    - ProgressIndicator shows current step visually with accessibility attributes
    - NavigationButtons validates on Next but not on Back
    - Button visibility changes appropriately per step
    - Both use useFormStore for state
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 3: Create MultiStepForm container and update apply page</name>
  <files>src/components/form/MultiStepForm.tsx, src/app/apply/page.tsx</files>
  <action>
    Create `src/components/form/MultiStepForm.tsx`:
    - "use client" directive
    - Import useForm, FormProvider from react-hook-form
    - Import zodResolver from @hookform/resolvers/zod
    - Import combinedApplicationSchema from schemas
    - Import useFormStore from stores
    - Import ProgressIndicator, StepContent, NavigationButtons

    **Setup:**
    1. Get currentStep, formData, isHydrated from useFormStore()
    2. Initialize useForm with:
       - resolver: zodResolver(combinedApplicationSchema)
       - defaultValues: formData (from store)
       - mode: "onSubmit"
    3. Use useEffect to call reset(formData) when isHydrated changes to true (restores form data after hydration)

    **Render:**
    1. If !isHydrated, show loading state (skeleton or "Loading...")
    2. Wrap everything in FormProvider {...methods}
    3. Wrap in <form onSubmit={handleSubmit(onSubmit)}>
    4. Render ProgressIndicator at top (hide on Welcome step 0 and Confirmation step 7)
    5. Render StepContent with current step
    6. Render NavigationButtons at bottom

    **onSubmit handler:**
    - For now, console.log the data (Phase 3 will wire to Convex)
    - Call setCurrentStep(7) to go to confirmation
    - Call resetForm() to clear localStorage

    Update `src/app/apply/page.tsx`:
    - Make it a client component ("use client")
    - Import and render StoreHydration
    - Import and render MultiStepForm
    - Remove old placeholder content
    - Add some container styling (min-h-screen, max-w-2xl centered, padding)
  </action>
  <verify>
    1. TypeScript compiles: `npx tsc --noEmit`
    2. Dev server runs: `npm run dev`
    3. Navigate to localhost:3000/apply - form renders without hydration errors
    4. Click through steps - Next advances, Back goes back
    5. Refresh page - step position restored from localStorage
    6. Fill some text, navigate away and back - data preserved
  </verify>
  <done>
    - MultiStepForm wraps everything in FormProvider
    - Form restores state from localStorage after hydration
    - /apply page renders the multi-step form
    - Navigation works (Next validates, Back doesn't)
    - Refresh preserves progress
    - No hydration mismatch errors in console
  </done>
</task>

</tasks>

<verification>
After all tasks complete, verify Phase 2 Success Criteria:

1. **Form state persists when navigating back and forward:**
   - Go to step 2, click Back, click Next
   - Any text entered should still be there
   - Test in browser: localStorage shows "ft-form-draft" key with data

2. **User cannot advance until current step validates:**
   - On step 1 (About You), click Next without filling required fields
   - Should see validation errors, should NOT advance
   - Fill required fields, click Next - should advance

3. **Refreshing browser restores form progress:**
   - Navigate to step 3
   - Refresh the page (F5)
   - Should still be on step 3 with any entered data

4. **Progress indicator shows correct step:**
   - At each step, verify the progress indicator highlights the correct step
   - Completed steps should show checkmarks

5. **Back navigation works without validation:**
   - On step 2, fill some invalid data (too short bio)
   - Click Back
   - Should go to step 1 without showing errors
   - Click Next back to step 2 - invalid data still there

6. **No console errors:**
   - Check browser console for hydration warnings or React errors
   - Should be clean
</verification>

<success_criteria>
- MultiStepForm renders at /apply without hydration errors
- FormProvider wraps all step components
- ProgressIndicator shows current step with accessibility
- NavigationButtons validates on Next, skips validation on Back
- Zustand store syncs with form state
- localStorage persistence works across page refresh
- All five Phase 2 success criteria from ROADMAP.md verified
</success_criteria>

<output>
After completion, create `.planning/phases/02-form-infrastructure/02-02-SUMMARY.md`
</output>

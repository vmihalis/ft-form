---
phase: 15-admin-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/admin/AdminDashboard.tsx
  - src/components/admin/AdminTabs.tsx
  - convex/forms.ts
  - src/components/form-builder/FormsList.tsx
autonomous: true

must_haves:
  truths:
    - "Admin dashboard has tabs for Applications, Submissions, and Forms"
    - "Clicking Forms tab shows list of all forms with status"
    - "Admin can duplicate an existing form from the forms list"
    - "Duplicated form has unique slug and draft status"
  artifacts:
    - path: "src/components/admin/AdminTabs.tsx"
      provides: "Tab navigation component"
      exports: ["AdminTabs"]
    - path: "convex/forms.ts"
      provides: "Form duplication mutation"
      contains: "duplicate"
  key_links:
    - from: "src/components/admin/AdminDashboard.tsx"
      to: "src/components/admin/AdminTabs.tsx"
      via: "imports AdminTabs"
      pattern: "import.*AdminTabs"
    - from: "src/components/form-builder/FormsList.tsx"
      to: "convex/forms.ts"
      via: "useMutation(api.forms.duplicate)"
      pattern: "api\\.forms\\.duplicate"
---

<objective>
Add tab navigation to admin dashboard and form duplication capability.

Purpose: Enable admins to access forms management from the main dashboard and quickly duplicate existing forms as templates for new forms.

Output: AdminDashboard with tabbed interface (Applications/Submissions/Forms) and FormsList with Duplicate action.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-admin-integration/15-RESEARCH.md

# Existing patterns
@src/components/admin/AdminDashboard.tsx
@src/components/form-builder/FormsList.tsx
@convex/forms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add AdminTabs and Update AdminDashboard</name>
  <files>
    src/components/admin/AdminTabs.tsx
    src/components/admin/AdminDashboard.tsx
  </files>
  <action>
Create AdminTabs component using @radix-ui/react-tabs (already available via shadcn):

1. Create `src/components/admin/AdminTabs.tsx`:
   - Use Tabs, TabsList, TabsTrigger, TabsContent from @/components/ui/tabs
   - Three tabs: "Applications" (legacy), "Submissions" (dynamic), "Forms"
   - Use URL query param `?tab=` for tab state (enables bookmarking/sharing)
   - Default to "applications" tab if no param
   - Use useSearchParams() and useRouter() for URL sync
   - Trigger styling: same as existing UI patterns

2. Update `src/components/admin/AdminDashboard.tsx`:
   - Replace direct ApplicationsTable render with AdminTabs
   - Pass selectedApplication/sheetOpen state to AdminTabs
   - AdminTabs handles which content to show based on active tab
   - Applications tab: render ApplicationsTable + ApplicationSheet (existing)
   - Submissions tab: show placeholder "Coming soon" (Plan 02 will implement)
   - Forms tab: render FormsList component (import from form-builder)

Tab structure:
```tsx
<Tabs value={tab} onValueChange={setTab}>
  <TabsList>
    <TabsTrigger value="applications">Applications</TabsTrigger>
    <TabsTrigger value="submissions">Submissions</TabsTrigger>
    <TabsTrigger value="forms">Forms</TabsTrigger>
  </TabsList>
  <TabsContent value="applications">
    <ApplicationsTable onRowClick={handleRowClick} />
  </TabsContent>
  <TabsContent value="submissions">
    <div>Coming soon...</div>
  </TabsContent>
  <TabsContent value="forms">
    <FormsList />
  </TabsContent>
</Tabs>
```
  </action>
  <verify>
Navigate to /admin - should see three tabs. Click each tab to verify content changes. URL should update with ?tab=submissions etc.
  </verify>
  <done>
Admin dashboard shows Applications, Submissions, Forms tabs. Tab state persists in URL. Forms tab shows FormsList. Applications tab shows existing ApplicationsTable functionality.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Form Duplicate Mutation and Action</name>
  <files>
    convex/forms.ts
    src/components/form-builder/FormsList.tsx
  </files>
  <action>
1. Add duplicate mutation to `convex/forms.ts`:

```typescript
/**
 * Duplicate an existing form
 * Creates copy with "-copy" suffix on slug (incrementing if exists)
 */
export const duplicate = mutation({
  args: { formId: v.id("forms") },
  handler: async (ctx, args) => {
    const form = await ctx.db.get(args.formId);
    if (!form) throw new Error("Form not found");

    // Generate unique slug with -copy suffix
    const baseSlug = form.slug + "-copy";
    let slug = baseSlug;
    let counter = 1;

    while (true) {
      const existing = await ctx.db
        .query("forms")
        .withIndex("by_slug", (q) => q.eq("slug", slug))
        .first();

      if (!existing) break;
      slug = `${baseSlug}-${counter++}`;
    }

    const now = Date.now();
    return await ctx.db.insert("forms", {
      name: `${form.name} (Copy)`,
      slug,
      description: form.description,
      status: "draft",
      draftSchema: form.draftSchema, // Copy the schema
      createdAt: now,
      updatedAt: now,
    });
  },
});
```

2. Update `src/components/form-builder/FormsList.tsx`:
   - Add useMutation for api.forms.duplicate
   - Add useRouter for navigation after duplicate
   - Add "Duplicate" action button in Actions column (next to external link)
   - Use Copy icon from lucide-react
   - On click: call duplicate mutation, then navigate to `/admin/forms/{newFormId}`
   - Handle loading state (disable button while duplicating)
   - Show toast on success/error (use sonner if available, else console.log)

Action button pattern:
```tsx
<button
  onClick={async (e) => {
    e.stopPropagation(); // Prevent row click
    try {
      const newFormId = await duplicate({ formId: form._id });
      router.push(`/admin/forms/${newFormId}`);
    } catch (error) {
      console.error("Failed to duplicate:", error);
    }
  }}
  className="inline-flex items-center text-sm text-muted-foreground hover:text-foreground"
>
  <Copy className="h-4 w-4" />
</button>
```
  </action>
  <verify>
Run `npx convex dev` to sync mutations. In admin/forms, click Duplicate on a form. Should create new form and navigate to its editor. Check new form has "(Copy)" suffix and unique slug.
  </verify>
  <done>
forms.duplicate mutation exists and works. FormsList has Duplicate action button. Clicking Duplicate creates copy and navigates to editor. Duplicate has unique slug (handles collisions).
  </done>
</task>

</tasks>

<verification>
1. Navigate to /admin - three tabs visible (Applications, Submissions, Forms)
2. Click Forms tab - shows list of forms
3. Click Duplicate on a form - creates copy with unique slug
4. New form opens in editor with "(Copy)" suffix in name
5. URL reflects current tab (?tab=forms)
6. Refresh page - tab state persists
</verification>

<success_criteria>
- Admin dashboard has functional tab navigation
- Forms tab displays FormsList component
- Form duplication creates new form with unique slug
- Tab state persists in URL query params
- All existing ApplicationsTable functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/15-admin-integration/15-01-SUMMARY.md`
</output>

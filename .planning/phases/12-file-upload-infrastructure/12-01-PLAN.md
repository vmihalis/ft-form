---
phase: 12-file-upload-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - convex/storage.ts
  - convex/crons.ts
  - convex/files.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "generateUploadUrl mutation returns a signed URL for file upload"
    - "deleteFile mutation removes file from storage"
    - "getFileUrl query returns serving URL for stored file"
    - "Orphaned files older than 24 hours are cleaned up daily"
  artifacts:
    - path: "convex/storage.ts"
      provides: "File upload/download/delete mutations and queries"
      exports: ["generateUploadUrl", "deleteFile", "getFileUrl", "getFileMetadata"]
    - path: "convex/files.ts"
      provides: "Internal orphan cleanup mutation"
      exports: ["cleanupOrphanedFiles"]
    - path: "convex/crons.ts"
      provides: "Scheduled cleanup job"
      contains: "crons.daily"
  key_links:
    - from: "convex/crons.ts"
      to: "convex/files.ts"
      via: "internal mutation call"
      pattern: "internal\\.files\\.cleanupOrphanedFiles"
    - from: "convex/storage.ts"
      to: "ctx.storage"
      via: "Convex storage API"
      pattern: "ctx\\.storage\\.(generateUploadUrl|delete|getUrl)"
---

<objective>
Create Convex backend infrastructure for file uploads including storage mutations, file URL queries, and orphaned file cleanup cron job.

Purpose: Provides the server-side foundation for file upload functionality. Frontend components will call these mutations to upload files immediately when selected (before form submission).

Output: Three Convex files providing complete file storage lifecycle management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-file-upload-infrastructure/12-RESEARCH.md

# Reference existing Convex patterns
@convex/schema.ts
@convex/forms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create storage mutations and queries</name>
  <files>convex/storage.ts</files>
  <action>
Create convex/storage.ts with:

1. **generateUploadUrl mutation** (no args):
   - Call `ctx.storage.generateUploadUrl()` and return the URL
   - No validation needed, URL is short-lived (1 hour)

2. **deleteFile mutation**:
   - Args: `{ storageId: v.id("_storage") }`
   - Call `ctx.storage.delete(args.storageId)`
   - Return void

3. **getFileUrl query**:
   - Args: `{ storageId: v.id("_storage") }`
   - Return `ctx.storage.getUrl(args.storageId)`
   - Can return null if file doesn't exist

4. **getFileMetadata query**:
   - Args: `{ storageId: v.id("_storage") }`
   - Use `ctx.db.system.get(args.storageId)` to access _storage system table
   - Return `{ contentType, size, sha256 }` or null

Follow existing patterns from convex/forms.ts for mutation/query structure.
  </action>
  <verify>
Run `npx convex dev` - should compile without errors.
Check `npx convex functions` lists: storage.generateUploadUrl, storage.deleteFile, storage.getFileUrl, storage.getFileMetadata
  </verify>
  <done>
Four storage functions exported and compiled: generateUploadUrl, deleteFile, getFileUrl, getFileMetadata
  </done>
</task>

<task type="auto">
  <name>Task 2: Create orphan cleanup cron job</name>
  <files>convex/files.ts, convex/crons.ts</files>
  <action>
Create convex/files.ts with internal cleanup mutation:

1. **cleanupOrphanedFiles internalMutation**:
   - Query all files from `_storage` system table
   - Query all submissions and extract storage IDs from data JSON
   - For each file: if not referenced by any submission AND older than 24 hours, delete it
   - Log count of deleted files to console

Create convex/crons.ts:

1. **Import cronJobs from "convex/server"**
2. **Import internal from "./_generated/api"**
3. **Define crons.daily** job:
   - Name: "cleanup orphaned files"
   - Schedule: 3:00 AM UTC daily
   - Action: internal.files.cleanupOrphanedFiles
4. **Export default crons**

Reference Convex cron docs pattern:
```typescript
import { cronJobs } from "convex/server";
import { internal } from "./_generated/api";

const crons = cronJobs();
crons.daily("name", { hourUTC: 3, minuteUTC: 0 }, internal.files.cleanupOrphanedFiles);
export default crons;
```
  </action>
  <verify>
Run `npx convex dev` - should compile without errors and show "Scheduling cron job: cleanup orphaned files".
Check `npx convex dashboard` shows cron job registered (or check CLI output).
  </verify>
  <done>
Cron job registered for daily orphan cleanup at 3 AM UTC. Internal mutation cleanupOrphanedFiles exists.
  </done>
</task>

</tasks>

<verification>
1. `npx convex functions` shows all 5 new functions:
   - storage.generateUploadUrl
   - storage.deleteFile
   - storage.getFileUrl
   - storage.getFileMetadata
   - files.cleanupOrphanedFiles (internal)
2. `npx convex dev` runs without errors
3. Cron job appears in Convex deployment output
</verification>

<success_criteria>
- generateUploadUrl returns a signed URL string
- deleteFile removes files from storage (testable via dashboard)
- getFileUrl returns serving URL for valid storage IDs
- Orphan cleanup cron is scheduled for daily execution
- All functions follow existing Convex patterns in the codebase
</success_criteria>

<output>
After completion, create `.planning/phases/12-file-upload-infrastructure/12-01-SUMMARY.md`
</output>

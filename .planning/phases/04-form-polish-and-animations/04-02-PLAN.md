---
phase: 04-form-polish-and-animations
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/app/providers.tsx
  - src/components/form/StepContent.tsx
  - src/lib/hooks/use-previous.ts
autonomous: true

must_haves:
  truths:
    - "Step transitions animate with fade and slide effects"
    - "Going forward slides content left, going back slides content right"
    - "Users with prefers-reduced-motion see instant transitions"
  artifacts:
    - path: "src/app/providers.tsx"
      provides: "MotionConfig wrapper for accessibility"
      contains: "MotionConfig"
    - path: "src/components/form/StepContent.tsx"
      provides: "AnimatePresence with direction-aware variants"
      contains: "AnimatePresence"
    - path: "src/lib/hooks/use-previous.ts"
      provides: "Hook for tracking previous step value"
      exports: ["usePrevious"]
  key_links:
    - from: "src/components/form/StepContent.tsx"
      to: "src/lib/stores/form-store.ts"
      via: "useFormStore for currentStep"
      pattern: "useFormStore.*currentStep"
    - from: "src/components/form/StepContent.tsx"
      to: "src/lib/hooks/use-previous.ts"
      via: "usePrevious hook"
      pattern: "usePrevious.*currentStep"
---

<objective>
Add direction-aware step transitions using Motion's AnimatePresence with automatic reduced motion support.

Purpose: Deliver the Typeform-style smooth transitions that make the form feel premium
Output: Steps animate with slide/fade on navigation, accessibility-compliant
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-form-polish-and-animations/04-RESEARCH.md
@.planning/phases/04-form-polish-and-animations/04-01-SUMMARY.md (if exists)
@src/app/providers.tsx
@src/components/form/StepContent.tsx
@src/lib/stores/form-store.ts

Key research findings:
- AnimatePresence with mode="wait" for sequential transitions
- Pass custom={direction} to BOTH AnimatePresence AND motion.div for exit animations
- MotionConfig reducedMotion="user" provides automatic accessibility
- usePrevious hook pattern for direction detection
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create usePrevious hook</name>
  <files>src/lib/hooks/use-previous.ts</files>
  <action>
    Create a new file `src/lib/hooks/use-previous.ts`:

    ```typescript
    import { useRef, useEffect } from "react";

    /**
     * Hook that returns the previous value of a variable.
     * Useful for detecting direction of step changes.
     */
    export function usePrevious<T>(value: T): T | undefined {
      const ref = useRef<T>();
      useEffect(() => {
        ref.current = value;
      });
      return ref.current;
    }
    ```

    This hook stores the previous render's value in a ref, allowing us to compare
    current step with previous step to determine navigation direction.
  </action>
  <verify>
    File exists at src/lib/hooks/use-previous.ts
    TypeScript compiles without errors: `npx tsc --noEmit`
  </verify>
  <done>usePrevious hook created and exports correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add MotionConfig to providers</name>
  <files>src/app/providers.tsx</files>
  <action>
    Update providers.tsx to wrap the app in MotionConfig for reduced motion support:

    1. Import MotionConfig: `import { MotionConfig } from "motion/react";`

    2. Wrap the ConvexProvider children in MotionConfig:
    ```typescript
    export function ConvexClientProvider({ children }: { children: ReactNode }) {
      return (
        <ConvexProvider client={convex}>
          <MotionConfig reducedMotion="user">
            {children}
          </MotionConfig>
        </ConvexProvider>
      );
    }
    ```

    The reducedMotion="user" setting automatically disables transform animations
    (like slide) while preserving opacity for users with prefers-reduced-motion enabled.
    This provides accessibility without any additional code in individual components.
  </action>
  <verify>
    File compiles: `npx tsc --noEmit`
    MotionConfig is wrapping children in the provider
  </verify>
  <done>MotionConfig wrapper added with reducedMotion="user" for accessibility</done>
</task>

<task type="auto">
  <name>Task 3: Add animated step transitions to StepContent</name>
  <files>src/components/form/StepContent.tsx</files>
  <action>
    Update StepContent.tsx to add direction-aware animations:

    1. Add imports at the top:
    ```typescript
    import { motion, AnimatePresence } from "motion/react";
    import { useFormStore } from "@/lib/stores/form-store";
    import { usePrevious } from "@/lib/hooks/use-previous";
    ```

    2. Define direction type and animation variants outside the component:
    ```typescript
    type Direction = "forward" | "back";

    const stepVariants = {
      initial: (direction: Direction) => ({
        x: direction === "forward" ? 50 : -50,
        opacity: 0,
      }),
      animate: {
        x: 0,
        opacity: 1,
      },
      exit: (direction: Direction) => ({
        x: direction === "forward" ? -50 : 50,
        opacity: 0,
      }),
    };
    ```

    3. Update the component to track direction and wrap content:
    ```typescript
    export function StepContent({ step }: StepContentProps) {
      // Track direction for animations
      const previousStep = usePrevious(step);
      const direction: Direction = (previousStep ?? 0) < step ? "forward" : "back";

      const stepInfo = FORM_STEPS[step];

      if (!stepInfo) {
        return (
          <div className="py-12 text-center">
            <p className="text-muted-foreground">Invalid step</p>
          </div>
        );
      }

      // Get the step content based on current step
      const getStepComponent = () => {
        switch (step) {
          case 0: return <WelcomeStep />;
          case 1: return <ApplicantInfoStep />;
          case 2: return <ProposalStep />;
          case 3: return <RoadmapStep />;
          case 4: return <ImpactStep />;
          case 5: return <LogisticsStep />;
          case 6: return <ReviewStep />;
          case 7: return <ConfirmationStep />;
          default:
            return (
              <div className="py-12 text-center">
                <p className="text-muted-foreground">Unknown step</p>
              </div>
            );
        }
      };

      return (
        <AnimatePresence mode="wait" custom={direction} initial={false}>
          <motion.div
            key={step}
            custom={direction}
            variants={stepVariants}
            initial="initial"
            animate="animate"
            exit="exit"
            transition={{ type: "tween", duration: 0.3, ease: "easeInOut" }}
          >
            {getStepComponent()}
          </motion.div>
        </AnimatePresence>
      );
    }
    ```

    Key points:
    - `mode="wait"` ensures old content exits before new content enters
    - `custom={direction}` passed to BOTH AnimatePresence and motion.div (critical for exit animations)
    - `initial={false}` prevents animation on first render (form already visible)
    - Using 50px slide (not 100%) for subtle, premium feel
    - 300ms duration matches Typeform-style timing
  </action>
  <verify>
    Run `npm run dev` and navigate through form steps
    Verify: clicking Next slides content left with fade
    Verify: clicking Back slides content right with fade
    Verify: transitions are smooth, not janky or overlapping
  </verify>
  <done>
    Step transitions animate smoothly:
    - Forward navigation slides content left
    - Back navigation slides content right
    - Both directions include fade effect
    - No visual glitches or layout shifts
  </done>
</task>

</tasks>

<verification>
1. `npm run dev` - form loads without errors
2. Navigate forward through steps - content slides left with fade
3. Navigate backward - content slides right with fade
4. Enable prefers-reduced-motion in browser/OS - transitions should be instant (no slide, possibly subtle fade)
5. No console errors related to motion/animations
</verification>

<success_criteria>
- Step transitions animate with slide + fade effects
- Direction is correct: forward=slide left, back=slide right
- Reduced motion users see instant transitions (accessibility)
- No layout shifts or visual glitches during animation
- Form state preserved during transitions (inputs retain values)
</success_criteria>

<output>
After completion, create `.planning/phases/04-form-polish-and-animations/04-02-SUMMARY.md`
</output>

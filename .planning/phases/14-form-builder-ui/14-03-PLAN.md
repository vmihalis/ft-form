---
phase: 14-form-builder-ui
plan: 03
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/form-builder/FieldPalette.tsx
  - src/components/form-builder/FormCanvas.tsx
  - src/components/form-builder/SortableFieldCard.tsx
  - src/components/form-builder/FieldPreview.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can add fields from type palette"
    - "Admin can drag-and-drop to reorder fields within form"
    - "Fields display with correct type icon and label"
  artifacts:
    - path: "src/components/form-builder/FieldPalette.tsx"
      provides: "Field type buttons for adding fields"
    - path: "src/components/form-builder/FormCanvas.tsx"
      provides: "Sortable field list with dnd-kit"
    - path: "src/components/form-builder/SortableFieldCard.tsx"
      provides: "Individual draggable field card"
    - path: "src/components/form-builder/FieldPreview.tsx"
      provides: "Field display in canvas"
  key_links:
    - from: "FieldPalette"
      to: "useFormBuilderStore.addField"
      via: "button click handler"
    - from: "FormCanvas"
      to: "DndContext/SortableContext"
      via: "dnd-kit wrappers"
    - from: "SortableFieldCard"
      to: "useSortable"
      via: "dnd-kit hook"
---

<objective>
Build field palette for adding fields and form canvas with drag-and-drop reordering.

Purpose: Fulfill BUILD-02 (add fields from palette), BUILD-03 (drag-and-drop reorder), and provide visual field representation in the builder.
Output: Working field palette that adds fields on click, and sortable canvas that supports drag-and-drop reordering.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-form-builder-ui/14-RESEARCH.md
@.planning/phases/14-form-builder-ui/14-01-SUMMARY.md
@src/lib/stores/form-builder-store.ts
@src/types/form-schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create field palette component</name>
  <files>src/components/form-builder/FieldPalette.tsx</files>
  <action>
Create src/components/form-builder/FieldPalette.tsx:

1. Define FIELD_TYPES array with all 10 field types:
   - text (Type icon), email (Mail), url (Link), textarea (AlignLeft)
   - number (Hash), date (Calendar)
   - select (ChevronDown), radio (Circle), checkbox (CheckSquare)
   - file (Upload)

2. Display as 2-column grid of buttons:
   - Each button shows icon + label
   - Compact height (h-auto py-3)
   - variant="outline"

3. On click:
   - Get selectedStepIndex from store
   - If no steps exist, call addStep() first
   - Call addField(selectedStepIndex, type)
   - Field is auto-selected after adding

4. Section heading: "Field Types" (font-semibold, text-sm, text-muted-foreground, uppercase tracking-wide)

Use lucide-react for icons.
Import { Type, Mail, Link, AlignLeft, Hash, Calendar, ChevronDown, Circle, CheckSquare, Upload } from 'lucide-react'
  </action>
  <verify>npx tsc --noEmit passes; FieldPalette renders all 10 field type buttons</verify>
  <done>FieldPalette displays 10 field types in 2-column grid, clicking adds field to current step</done>
</task>

<task type="auto">
  <name>Task 2: Create form canvas with dnd-kit sortable</name>
  <files>src/components/form-builder/FormCanvas.tsx, src/components/form-builder/SortableFieldCard.tsx</files>
  <action>
Create sortable form canvas:

1. src/components/form-builder/FormCanvas.tsx:
   - Import DndContext, closestCenter, PointerSensor, KeyboardSensor, useSensor, useSensors from @dnd-kit/core
   - Import SortableContext, verticalListSortingStrategy, arrayMove from @dnd-kit/sortable
   - Import DragOverlay from @dnd-kit/core

   - Get schema.steps[selectedStepIndex].fields from store
   - Track activeId state for drag overlay

   - Configure sensors:
     - PointerSensor with activationConstraint: { distance: 8 } (prevent accidental drags)
     - KeyboardSensor with sortableKeyboardCoordinates

   - handleDragEnd:
     - Get active.id and over.id
     - Find oldIndex and newIndex
     - Call store.reorderFields(selectedStepIndex, oldIndex, newIndex)

   - Render:
     - DndContext with sensors and closestCenter collision
     - SortableContext with field IDs and verticalListSortingStrategy
     - Map fields to SortableFieldCard components
     - DragOverlay with FieldPreview (when activeId exists)

   - Empty state: "Add your first field from the palette" centered message

2. src/components/form-builder/SortableFieldCard.tsx:
   - Import useSortable from @dnd-kit/sortable
   - Import CSS from @dnd-kit/utilities

   - useSortable({ id: field.id }) returns attributes, listeners, setNodeRef, transform, transition, isDragging

   - Style object: { transform: CSS.Transform.toString(transform), transition, opacity: isDragging ? 0.5 : 1 }

   - Card with:
     - Drag handle (GripVertical icon) - spread {...attributes} {...listeners} on handle only
     - FieldPreview component
     - Click handler to selectField

   - Selected state: ring-2 ring-primary when field.id === selectedFieldId
   - Hover state: cursor-pointer, hover:bg-muted/50
  </action>
  <verify>npm run build succeeds; fields can be dragged to reorder within canvas</verify>
  <done>FormCanvas displays sortable fields with drag handles, reordering updates store</done>
</task>

<task type="auto">
  <name>Task 3: Create field preview component</name>
  <files>src/components/form-builder/FieldPreview.tsx</files>
  <action>
Create src/components/form-builder/FieldPreview.tsx:

Props: { field: FormField, isDragging?: boolean }

Display:
1. Left side: Field type icon (same icons as palette)
2. Middle:
   - Field label (font-medium)
   - Field type as badge (text-xs, muted)
   - "Required" badge if field.required
3. Right side: Chevron indicator (optional, for expansion hint)

Layout:
- flex items-center gap-3
- Padding: p-4
- Background: bg-card when dragging

Helper function getFieldIcon(type: FieldType) returns appropriate lucide icon.

For select/radio fields: Show option count (e.g., "3 options")
For textarea: Show "Long text" label
For file: Show "File upload" label
  </action>
  <verify>npx tsc --noEmit passes; FieldPreview renders field info with correct icon</verify>
  <done>FieldPreview displays field label, type icon, required badge</done>
</task>

</tasks>

<verification>
- FieldPalette shows all 10 field types
- Clicking palette button adds field to current step
- FormCanvas displays fields with drag handles
- Dragging field reorders within step
- Selected field has ring highlight
- Empty state shows when no fields exist
</verification>

<success_criteria>
1. PALETTE: 10 field types in 2-column grid with icons
2. ADD FIELD: Click adds field to selectedStepIndex, auto-selects new field
3. DRAG HANDLES: Each field card has GripVertical drag handle
4. REORDER: Dragging updates field order in store
5. SELECTION: Clicking field selects it (ring highlight)
6. EMPTY STATE: Canvas shows message when step has no fields
</success_criteria>

<output>
After completion, create `.planning/phases/14-form-builder-ui/14-03-SUMMARY.md`
</output>

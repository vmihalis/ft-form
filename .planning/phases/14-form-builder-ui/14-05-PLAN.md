---
phase: 14-form-builder-ui
plan: 05
type: execute
wave: 4
depends_on: ["14-04"]
files_modified:
  - src/components/form-builder/PreviewPanel.tsx
  - src/components/form-builder/FormStatusActions.tsx
  - src/components/form-builder/FormBuilder.tsx
  - src/app/admin/forms/[formId]/page.tsx
autonomous: false

must_haves:
  truths:
    - "Real-time preview shows form as users will see it"
    - "Form has draft/published/archived status lifecycle"
    - "Publishing creates immutable form version snapshot"
  artifacts:
    - path: "src/components/form-builder/PreviewPanel.tsx"
      provides: "Live form preview using DynamicFormRenderer"
    - path: "src/components/form-builder/FormStatusActions.tsx"
      provides: "Publish/archive action buttons"
  key_links:
    - from: "PreviewPanel"
      to: "DynamicFormRenderer"
      via: "component reuse from Phase 13"
    - from: "FormStatusActions"
      to: "api.forms.publish"
      via: "useMutation hook"
    - from: "FormStatusActions"
      to: "api.forms.archive"
      via: "useMutation hook"
---

<objective>
Add real-time preview panel using existing DynamicFormRenderer, implement form status actions (publish/archive), and add save functionality with dirty state tracking.

Purpose: Fulfill BUILD-06 (real-time preview), BUILD-07 (status lifecycle), BUILD-08 (publishing creates version), completing the form builder.
Output: Fully functional form builder with preview mode, save/publish/archive actions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/14-form-builder-ui/14-RESEARCH.md
@.planning/phases/14-form-builder-ui/14-04-SUMMARY.md
@.planning/phases/13-dynamic-form-renderer/13-03-SUMMARY.md
@src/components/dynamic-form/DynamicFormRenderer.tsx
@convex/forms.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create preview panel component</name>
  <files>src/components/form-builder/PreviewPanel.tsx</files>
  <action>
Create src/components/form-builder/PreviewPanel.tsx:

Purpose: Show live preview of form using DynamicFormRenderer from Phase 13.

1. Get schema from useFormBuilderStore(s => s.schema)

2. Create preview-safe schema:
   - Deep clone schema to avoid store mutations
   - Filter out fields without labels (incomplete fields)
   - Filter out steps without fields (empty steps)

3. Render preview:
   - Container with mobile-like frame (max-w-md, mx-auto, rounded-lg, shadow-lg, bg-white)
   - Header bar: "Preview" title with device toggle (optional: desktop/mobile)
   - Scrollable content area
   - Use DynamicFormRenderer or DynamicStepContent for step-by-step preview

4. Empty state:
   - If schema.steps.length === 0 or all steps empty
   - Show "Add fields to see preview" message

5. Preview mode considerations:
   - Disable actual form submission (preview only)
   - Show placeholder values or leave empty
   - Progress indicator works based on step count

Alternative simpler approach:
   - Create PreviewStep component that renders one step's fields
   - Use existing field components from Phase 13 in read-only mode
   - Tab through steps manually in preview

Styling:
- Preview container has border and shadow to look like device
- Scale down slightly (transform: scale(0.9)) to fit panel
  </action>
  <verify>npx tsc --noEmit passes; PreviewPanel shows form fields as they'll appear to users</verify>
  <done>PreviewPanel displays live preview of current schema using Phase 13 components</done>
</task>

<task type="auto">
  <name>Task 2: Create form status actions and save functionality</name>
  <files>src/components/form-builder/FormStatusActions.tsx, src/app/admin/forms/[formId]/page.tsx</files>
  <action>
1. Create src/components/form-builder/FormStatusActions.tsx:

Props: { formId: Id<"forms"> }

Features:

**Status Badge**
- Show current form status from useQuery(api.forms.getById)
- draft: yellow badge
- published: green badge with version number
- archived: gray badge

**Save Button**
- Check isDirty from store
- If dirty: "Save" (primary variant)
- If clean: "Saved" (outline variant, disabled)
- On click: call forms.update({ formId, draftSchema: JSON.stringify(schema) })
- After save: markClean()

**Publish Button** (shown for draft/published)
- Validate schema before publish:
  - At least one step
  - Each step has at least one field
  - Each field has a label
  - Select/radio fields have at least one option
- If validation fails: show error toast with issues
- If dirty: save first, then publish
- Call forms.publish({ formId })
- Show success toast with version number

**Archive Button** (shown for published only)
- Confirmation dialog: "Archive this form? Users won't be able to submit."
- Call forms.archive({ formId })

**Republish Button** (shown for published, when draft differs)
- Same as publish, but labeled "Republish"

2. Update src/app/admin/forms/[formId]/page.tsx header:
   - Add FormStatusActions component
   - Add preview toggle button (Eye icon)
   - Preview mode: hide left panel, expand center to show PreviewPanel

Layout in header:
- Left: Back button + form name
- Right: FormStatusActions (status badge, save, publish/archive)
  </action>
  <verify>npm run build succeeds; save/publish buttons work and update form status</verify>
  <done>FormStatusActions shows status, enables save/publish/archive with validation</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete form builder flow</name>
  <what-built>
Complete form builder UI with:
- Form creation with name/slug
- Three-panel layout with field palette, canvas, property panel
- Drag-and-drop field reordering
- Field property editing (label, placeholder, required, options, validation)
- Real-time preview
- Save/publish/archive status actions
  </what-built>
  <how-to-verify>
1. Navigate to /admin (login if needed)
2. Click through to /admin/forms
3. Click "New Form", enter name "Test Form" and slug "test-form", submit
4. Should redirect to form builder
5. Add a text field from palette - verify it appears in canvas
6. Click field, verify PropertyPanel shows in right panel
7. Change label to "Your Name", verify canvas updates
8. Toggle required on
9. Add a select field
10. Add 3 options: "Option A", "Option B", "Option C"
11. Drag the select field above the text field
12. Verify order changed
13. Click Preview toggle - verify preview shows the form
14. Click Save - verify "Saved" state
15. Click Publish - verify success and status changes to "published"
16. Navigate to /apply/test-form - verify form renders correctly
17. Return to builder, add another field, verify status shows as editable draft
  </how-to-verify>
  <resume-signal>Type "approved" if all steps work, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- Preview panel shows current form fields
- Save button enabled when dirty, disabled when clean
- Publish validates schema, shows errors if invalid
- Publishing increments version number
- Published form accessible at /apply/[slug]
- Archive removes form from public access
</verification>

<success_criteria>
1. PREVIEW: Real-time preview reflects current schema
2. SAVE: Dirty state tracked, save persists to database
3. PUBLISH VALIDATION: Empty steps/fields/options caught before publish
4. PUBLISH: Creates immutable version, updates status to published
5. ARCHIVE: Changes status to archived, form no longer accessible
6. E2E: Create form -> add fields -> reorder -> save -> publish -> access at public URL
</success_criteria>

<output>
After completion, create `.planning/phases/14-form-builder-ui/14-05-SUMMARY.md`
</output>

---
phase: 05-admin-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/auth/session.ts
autonomous: true
user_setup:
  - service: local-environment
    why: "JWT session signing requires secrets"
    env_vars:
      - name: ADMIN_PASSWORD
        source: "Create any password string for admin access"
      - name: SESSION_SECRET
        source: "Run: openssl rand -base64 32"

must_haves:
  truths:
    - "Session utilities can encrypt and decrypt JWT payloads"
    - "Session can be created and stored in HttpOnly cookie"
    - "Session can be deleted from cookies"
  artifacts:
    - path: "src/lib/auth/session.ts"
      provides: "JWT session management functions"
      exports: ["encrypt", "decrypt", "createSession", "deleteSession"]
      min_lines: 40
  key_links:
    - from: "src/lib/auth/session.ts"
      to: "jose"
      via: "SignJWT, jwtVerify imports"
      pattern: "import.*from 'jose'"
---

<objective>
Install jose library and create session management utilities for JWT-based authentication.

Purpose: Provides the foundation for password-protected admin routes with secure cookie-based sessions.
Output: Working session.ts with encrypt, decrypt, createSession, and deleteSession functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-admin-authentication/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install jose and create session utilities</name>
  <files>
    package.json
    src/lib/auth/session.ts
  </files>
  <action>
1. Install jose library:
   ```bash
   npm install jose
   ```

2. Create `src/lib/auth/` directory.

3. Create `src/lib/auth/session.ts` with the following:
   - Add `import 'server-only'` at the very top (prevents client-side import)
   - Import `SignJWT`, `jwtVerify` from 'jose'
   - Import `cookies` from 'next/headers'

   - Define `secretKey = process.env.SESSION_SECRET`
   - Define `encodedKey = new TextEncoder().encode(secretKey)`

   - Define `SessionPayload` interface with:
     - `isAuthenticated: boolean`
     - `expiresAt: Date`

   - Export `async function encrypt(payload: SessionPayload): Promise<string>`
     - Use `new SignJWT(payload as unknown as Record<string, unknown>)`
     - Set protected header with `alg: 'HS256'`
     - Set issued at with `.setIssuedAt()`
     - Set expiration with `.setExpirationTime('7d')`
     - Sign with encodedKey and return result

   - Export `async function decrypt(session: string | undefined = ''): Promise<SessionPayload | null>`
     - Try `jwtVerify(session, encodedKey, { algorithms: ['HS256'] })`
     - Return payload cast to SessionPayload
     - Catch errors and return null

   - Export `async function createSession(): Promise<void>`
     - Calculate expiresAt as 7 days from now
     - Call encrypt with `{ isAuthenticated: true, expiresAt }`
     - Get cookieStore with `await cookies()`
     - Set 'session' cookie with:
       - httpOnly: true
       - secure: process.env.NODE_ENV === 'production'
       - expires: expiresAt
       - sameSite: 'lax'
       - path: '/'

   - Export `async function deleteSession(): Promise<void>`
     - Get cookieStore with `await cookies()`
     - Delete 'session' cookie

Note: The 'server-only' import ensures this module throws an error if accidentally imported in a client component, protecting SESSION_SECRET from exposure.
  </action>
  <verify>
    - File exists: `ls src/lib/auth/session.ts`
    - TypeScript compiles: `npx tsc --noEmit`
    - jose installed: `grep jose package.json`
  </verify>
  <done>
    - jose library installed in package.json
    - session.ts exports encrypt, decrypt, createSession, deleteSession
    - File includes 'server-only' import for security
  </done>
</task>

</tasks>

<verification>
- `npm run build` succeeds (no TypeScript errors)
- `src/lib/auth/session.ts` contains all 4 exported functions
- `package.json` includes jose dependency
</verification>

<success_criteria>
- jose library installed
- session.ts created with JWT encrypt/decrypt and cookie management
- File protected with 'server-only' import
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-authentication/05-01-SUMMARY.md`
</output>

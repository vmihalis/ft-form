---
phase: 05-admin-authentication
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/middleware.ts
  - src/app/admin/login/page.tsx
  - src/app/admin/login/actions.ts
  - src/app/admin/page.tsx
  - src/app/admin/actions.ts
autonomous: true

must_haves:
  truths:
    - "Navigating to /admin without login redirects to /admin/login"
    - "Entering correct password grants access to admin dashboard"
    - "Session persists across browser refresh"
    - "Logout button clears session and redirects to login page"
    - "Invalid password shows error message without granting access"
  artifacts:
    - path: "src/middleware.ts"
      provides: "Route protection for /admin/* paths"
      exports: ["middleware", "config"]
      min_lines: 20
    - path: "src/app/admin/login/actions.ts"
      provides: "Server action for login form"
      exports: ["login"]
      min_lines: 20
    - path: "src/app/admin/login/page.tsx"
      provides: "Login form UI with password input"
      min_lines: 30
    - path: "src/app/admin/page.tsx"
      provides: "Protected admin page with logout button"
      min_lines: 20
    - path: "src/app/admin/actions.ts"
      provides: "Server action for logout"
      exports: ["logout"]
      min_lines: 8
  key_links:
    - from: "src/middleware.ts"
      to: "src/lib/auth/session.ts"
      via: "decrypt import"
      pattern: "import.*decrypt.*from '@/lib/auth/session'"
    - from: "src/app/admin/login/actions.ts"
      to: "src/lib/auth/session.ts"
      via: "createSession import"
      pattern: "import.*createSession.*from '@/lib/auth/session'"
    - from: "src/app/admin/page.tsx"
      to: "src/app/admin/actions.ts"
      via: "form action={logout}"
      pattern: "action=\\{logout\\}"
---

<objective>
Create login page, middleware protection, and logout functionality for admin routes.

Purpose: Completes password-protected admin access with session persistence.
Output: Working login flow where /admin requires authentication, login grants access, and logout revokes it.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-admin-authentication/05-RESEARCH.md
@.planning/phases/05-admin-authentication/05-01-SUMMARY.md
@src/lib/auth/session.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create middleware for route protection</name>
  <files>src/middleware.ts</files>
  <action>
Create `src/middleware.ts` (at src/ root, NOT in app/):

1. Import `NextRequest`, `NextResponse` from 'next/server'
2. Import `decrypt` from '@/lib/auth/session'

3. Export async function `middleware(request: NextRequest)`:
   - Get path from `request.nextUrl.pathname`
   - If path === '/admin/login', return `NextResponse.next()` (skip auth check)
   - Get session cookie: `request.cookies.get('session')?.value`
   - Call `await decrypt(cookie)`
   - If session is null OR !session.isAuthenticated:
     - Return `NextResponse.redirect(new URL('/admin/login', request.nextUrl))`
   - Otherwise return `NextResponse.next()`

4. Export config with matcher:
   ```typescript
   export const config = {
     matcher: ['/admin/:path*'],
   }
   ```

Important: The middleware file MUST be at `src/middleware.ts`, not `src/app/middleware.ts`. Next.js only recognizes middleware at the src root or project root.
  </action>
  <verify>
    - File exists at correct location: `ls src/middleware.ts`
    - Not in app folder: `ls src/app/middleware.ts` should fail
  </verify>
  <done>
    - Middleware protects all /admin/* routes except /admin/login
    - Unauthenticated requests redirect to /admin/login
  </done>
</task>

<task type="auto">
  <name>Task 2: Create login page with form and server action</name>
  <files>
    src/app/admin/login/actions.ts
    src/app/admin/login/page.tsx
  </files>
  <action>
1. Create `src/app/admin/login/actions.ts`:
   - Add 'use server' directive at top
   - Import `createSession` from '@/lib/auth/session'
   - Import `redirect` from 'next/navigation'
   - Import `z` from 'zod'

   - Define loginSchema:
     ```typescript
     const loginSchema = z.object({
       password: z.string().min(1, 'Password is required'),
     })
     ```

   - Export async function `login(prevState: unknown, formData: FormData)`:
     - Parse password from formData with loginSchema.safeParse
     - If parse fails, return `{ error: 'Password is required' }`
     - Compare password with `process.env.ADMIN_PASSWORD`
     - If no match, return `{ error: 'Invalid password' }`
     - If match, call `await createSession()`
     - Then call `redirect('/admin')` (must be last line, do NOT wrap in try/catch)

2. Update `src/app/admin/login/page.tsx`:
   - Add 'use client' directive at top
   - Import `useActionState` from 'react'
   - Import `login` from './actions'
   - Import `Button` from '@/components/ui/button'
   - Import `Input` from '@/components/ui/input'
   - Import `Label` from '@/components/ui/label'

   - Use `const [state, formAction, isPending] = useActionState(login, null)`

   - Return centered layout with:
     - h1: "Admin Login"
     - p: "Enter password to access dashboard"
     - form with action={formAction}:
       - Label and Input for password (type="password", name="password", required)
       - Error message if state?.error exists (text-sm text-destructive)
       - Submit Button with "Sign in" text, disabled={isPending}
       - Show "Signing in..." when isPending

   - Style consistently with existing UI (centered, max-w-sm, space-y-6)
  </action>
  <verify>
    - Files exist: `ls src/app/admin/login/actions.ts src/app/admin/login/page.tsx`
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
    - Login form shows password input with submit button
    - Invalid password shows error message
    - Valid password creates session and redirects to /admin
  </done>
</task>

<task type="auto">
  <name>Task 3: Update admin page with logout and protection</name>
  <files>
    src/app/admin/actions.ts
    src/app/admin/page.tsx
  </files>
  <action>
1. Create `src/app/admin/actions.ts`:
   - Add 'use server' directive
   - Import `deleteSession` from '@/lib/auth/session'
   - Import `redirect` from 'next/navigation'

   - Export async function `logout()`:
     - Call `await deleteSession()`
     - Call `redirect('/admin/login')`

2. Update `src/app/admin/page.tsx`:
   - Remove 'use client' if present (this is a server component)
   - Import `cookies` from 'next/headers'
   - Import `redirect` from 'next/navigation'
   - Import `decrypt` from '@/lib/auth/session'
   - Import `logout` from './actions'
   - Import `Button` from '@/components/ui/button'

   - Make component async: `export default async function AdminPage()`

   - Add defense-in-depth check at start:
     ```typescript
     const cookieStore = await cookies()
     const session = await decrypt(cookieStore.get('session')?.value)

     if (!session?.isAuthenticated) {
       redirect('/admin/login')
     }
     ```

   - Keep existing content but add logout form:
     - form with action={logout}
     - Button variant="outline" with text "Logout"

   - Keep the existing placeholder content (h1 "Admin Dashboard", etc.)
     This will be replaced in Phase 6 with actual dashboard UI.
  </action>
  <verify>
    - Files exist: `ls src/app/admin/actions.ts src/app/admin/page.tsx`
    - TypeScript compiles: `npx tsc --noEmit`
  </verify>
  <done>
    - Admin page is a server component with session verification
    - Logout button clears session and redirects to login
    - Defense in depth: both middleware AND page verify session
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:3000/admin
   - Should redirect to /admin/login
3. Enter wrong password, submit
   - Should show "Invalid password" error
4. Enter correct password (from ADMIN_PASSWORD env var), submit
   - Should redirect to /admin dashboard
5. Refresh page
   - Should stay on /admin (session persisted)
6. Click Logout button
   - Should redirect to /admin/login
7. Try to access /admin directly
   - Should redirect to /admin/login (session cleared)
</verification>

<success_criteria>
- Middleware redirects unauthenticated /admin/* requests to /admin/login
- Login form validates password against ADMIN_PASSWORD env var
- Correct password creates session and grants access
- Session persists across browser refresh (7 day expiry)
- Logout clears session and redirects to login
- Invalid password shows error without granting access
</success_criteria>

<output>
After completion, create `.planning/phases/05-admin-authentication/05-02-SUMMARY.md`
</output>

---
phase: 13-dynamic-form-renderer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/apply/[slug]/page.tsx
  - src/lib/schemas/dynamic-form.ts
  - src/lib/stores/dynamic-form-store.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Visiting /apply/[slug] loads form data from Convex by slug"
    - "Invalid slugs or unpublished forms show 404-style message"
    - "Form progress persists in localStorage keyed by slug"
  artifacts:
    - path: "src/app/apply/[slug]/page.tsx"
      provides: "Dynamic route entry point"
      min_lines: 15
    - path: "src/lib/schemas/dynamic-form.ts"
      provides: "Schema-to-Zod conversion functions"
      exports: ["buildFieldSchema", "buildFormSchema", "getStepFieldIds"]
    - path: "src/lib/stores/dynamic-form-store.ts"
      provides: "Form draft persistence by slug"
      exports: ["useDynamicFormStore"]
  key_links:
    - from: "src/app/apply/[slug]/page.tsx"
      to: "convex/forms.ts"
      via: "useQuery(api.forms.getBySlug)"
      pattern: "useQuery.*getBySlug"
    - from: "src/lib/schemas/dynamic-form.ts"
      to: "src/types/form-schema.ts"
      via: "FormField type import"
      pattern: "import.*FormField.*form-schema"
---

<objective>
Create dynamic form infrastructure: route, Zod schema generation, and draft persistence

Purpose: Enable dynamic form rendering at /apply/[slug] with schema-driven validation and localStorage persistence
Output: Dynamic route page, schema-to-Zod conversion, and slug-keyed Zustand store
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-dynamic-form-renderer/13-RESEARCH.md

# Prior work
@src/types/form-schema.ts
@convex/forms.ts
@src/lib/stores/form-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dynamic form route and Zod schema generation</name>
  <files>
    - src/app/apply/[slug]/page.tsx
    - src/lib/schemas/dynamic-form.ts
  </files>
  <action>
Create dynamic route page at src/app/apply/[slug]/page.tsx:
- Accept slug from params (Next.js 15 async params pattern: `params: Promise<{ slug: string }>`)
- Use "use client" directive (Convex hooks require client)
- Use `useQuery(api.forms.getBySlug, { slug })` to fetch form data
- Show loading spinner while query pending
- Show "Form not found" message if query returns null (form doesn't exist or not published)
- If form exists, render placeholder div with form name and version (actual renderer in Plan 02)

Create schema-to-Zod conversion at src/lib/schemas/dynamic-form.ts:
- Import z from "zod" and FormField, FormSchema, FieldType from @/types/form-schema
- Export `buildFieldSchema(field: FormField): z.ZodTypeAny` function:
  - text, url, textarea: z.string() with optional minLength/maxLength from validation
  - email: z.string().email() with customMessage
  - number: z.coerce.number() with optional min/max from validation
  - date: z.string().min(1, "Date is required")
  - select, radio: z.enum() from field.options values (handle empty options gracefully)
  - checkbox: z.boolean() (for required checkboxes, wrap with z.literal(true) check in form logic)
  - file: z.string() (stores Id<"_storage">)
  - For non-required fields: make schema optional with `.optional().or(z.literal(""))`
- Export `buildFormSchema(schema: FormSchema): z.ZodObject<Record<string, z.ZodTypeAny>>`:
  - Iterate all steps and fields
  - Build shape object with field.id as key
  - Return z.object(shape)
- Export `getStepFieldIds(schema: FormSchema, stepIndex: number): string[]`:
  - Return field IDs for given step index
  - Return empty array if step doesn't exist

IMPORTANT: For email validation, use `.email(field.validation?.customMessage || "Invalid email address")`
IMPORTANT: Handle select/radio with no options - default to z.string() to avoid enum errors
  </action>
  <verify>
- `ls src/app/apply/\[slug\]/page.tsx` exists
- `grep "getBySlug" src/app/apply/\[slug\]/page.tsx` shows query usage
- `grep "buildFormSchema" src/lib/schemas/dynamic-form.ts` shows export
  </verify>
  <done>
- Dynamic route exists at /apply/[slug]
- Schema conversion functions exported
- Route loads form data from Convex
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dynamic form Zustand store</name>
  <files>src/lib/stores/dynamic-form-store.ts</files>
  <action>
Create Zustand store for dynamic form drafts at src/lib/stores/dynamic-form-store.ts:

Follow the existing pattern from src/lib/stores/form-store.ts but with multi-form support:

```typescript
import { create } from "zustand";
import { persist, createJSONStorage } from "zustand/middleware";

interface FormDraft {
  currentStep: number;
  completedSteps: number[];
  formData: Record<string, unknown>;
  versionId: string;  // Lock to version at form start
}

interface DynamicFormState {
  // State
  drafts: Record<string, FormDraft>;  // Keyed by slug
  isHydrated: boolean;

  // Actions
  getDraft: (slug: string) => FormDraft | null;
  initDraft: (slug: string, versionId: string) => void;
  setCurrentStep: (slug: string, step: number) => void;
  markStepCompleted: (slug: string, step: number) => void;
  updateFormData: (slug: string, data: Record<string, unknown>) => void;
  clearDraft: (slug: string) => void;
  setHydrated: (value: boolean) => void;
}
```

Implementation notes:
- Use `persist` middleware with localStorage
- Storage name: "ft-dynamic-form-drafts"
- skipHydration: true (same pattern as existing form-store)
- onRehydrateStorage callback to set isHydrated
- partialize to only persist drafts (not isHydrated)
- getDraft returns null if slug not in drafts
- initDraft creates new draft if doesn't exist (with step 0, empty completedSteps, empty formData)
- All other actions no-op if slug not in drafts (don't create new entries)

Export useDynamicFormStore hook.
  </action>
  <verify>
- `grep "useDynamicFormStore" src/lib/stores/dynamic-form-store.ts` shows export
- `grep "ft-dynamic-form-drafts" src/lib/stores/dynamic-form-store.ts` shows storage name
  </verify>
  <done>
- Zustand store manages multiple form drafts by slug
- Drafts persist to localStorage
- Actions update specific slug's draft
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Run `npm run build` - should compile without errors
2. Visit /apply/test-slug - should show "Form not found" (no form exists)
3. Check localStorage for "ft-dynamic-form-drafts" key after store hydration
</verification>

<success_criteria>
- Dynamic route at /apply/[slug] loads form data from Convex
- Invalid/unpublished slugs show graceful error state
- buildFormSchema converts FormSchema to Zod validation
- Zustand store persists drafts by slug in localStorage
</success_criteria>

<output>
After completion, create `.planning/phases/13-dynamic-form-renderer/13-01-SUMMARY.md`
</output>
